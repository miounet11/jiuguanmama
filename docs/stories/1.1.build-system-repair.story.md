# Story 1.1: Emergency Build System Repair

## Status
Draft

## Story
**As a** development team,  
**I want** the application to build successfully,  
**so that** we can deploy to production.

## Acceptance Criteria
1. Node.js downgraded to v18.x LTS
2. vue-tsc configuration fixed for successful compilation
3. All TypeScript errors resolved
4. npm run build completes successfully
5. Docker build completes without errors

## Tasks / Subtasks

- [ ] **Task 1: Fix Node.js Version Compatibility** (AC: 1)
  - [ ] Create `.nvmrc` file with `18.20.4` (latest Node 18 LTS)
  - [ ] Update package.json engines field to require Node 18
  - [ ] Update all GitHub Actions/CI configurations to use Node 18
  - [ ] Verify all developers have Node 18 installed
  - [ ] Test basic npm install with Node 18

- [ ] **Task 2: Resolve vue-tsc Build Failure** (AC: 2)
  - [ ] Identify root cause of "Search string not found: /supportedTSExtensions" error
  - [ ] Update vue-tsc to latest compatible version (^1.8.27)
  - [ ] If version update doesn't work, check TypeScript version compatibility
  - [ ] Update vite and @vitejs/plugin-vue to latest stable versions
  - [ ] Test `npm run build` in apps/web directory
  - [ ] Document the fix in troubleshooting guide

- [ ] **Task 3: Fix TypeScript Compilation Errors** (AC: 3)
  - [ ] Run `npx tsc --noEmit` in apps/api to identify all TS errors
  - [ ] Run `vue-tsc --noEmit` in apps/web to identify all Vue TS errors
  - [ ] Fix type errors in API project (likely missing types or incorrect imports)
  - [ ] Fix type errors in Web project (likely Vue 3 type issues)
  - [ ] Update tsconfig.json files if needed for proper module resolution
  - [ ] Ensure @types packages are up to date

- [ ] **Task 4: Ensure Monorepo Build Success** (AC: 4)
  - [ ] Lock all dependency versions by committing package-lock.json files
  - [ ] Update turbo.json configuration if needed
  - [ ] Run `npm run build` from root directory
  - [ ] Verify both apps/api and apps/web build successfully
  - [ ] Check that dist/build folders are created with output files
  - [ ] Test that built API server starts successfully
  - [ ] Test that built Vue app serves correctly

- [ ] **Task 5: Fix Docker Build Process** (AC: 5)
  - [ ] Review and fix Dockerfile for Node 18 compatibility
  - [ ] Ensure multi-stage build works correctly
  - [ ] Update base images to node:18-alpine
  - [ ] Fix any path or permission issues in Docker build
  - [ ] Test docker-compose build command
  - [ ] Verify container starts and runs successfully
  - [ ] Document Docker build commands and requirements

- [ ] **Task 6: Verify Complete Build Pipeline** (AC: 1-5)
  - [ ] Clean install from scratch (`rm -rf node_modules package-lock.json`)
  - [ ] Run full install and build sequence
  - [ ] Document the exact commands for clean build
  - [ ] Create build verification checklist
  - [ ] Test on at least 2 different machines/environments

## Dev Notes

### Current Build Issues Identified
Based on the risk assessment and error logs:
1. **Node.js v24.4.1 incompatibility** - vue-tsc crashes with "Search string not found" error
2. **TypeScript configuration issues** - Multiple compilation errors preventing build
3. **Dependency version mismatches** - No package-lock.json causing inconsistent installs
4. **Docker configuration outdated** - Needs update for Node 18 and proper build stages

### Project Structure Context
**Monorepo Structure** (from package.json analysis):
```
/jiuguanbaba/
├── cankao/tavernai-plus/     # Main project root
│   ├── apps/
│   │   ├── api/              # Backend Express server
│   │   │   ├── src/
│   │   │   ├── dist/         # Build output
│   │   │   └── package.json
│   │   └── web/              # Frontend Vue application
│   │       ├── src/
│   │       ├── dist/         # Build output
│   │       └── package.json
│   ├── packages/             # Shared packages (currently empty)
│   ├── docker/               # Docker configurations
│   ├── package.json          # Root package.json
│   └── turbo.json           # Turborepo configuration
```

### Technology Stack (from package.json files)
**Backend (apps/api):**
- Node.js runtime (needs v18.x LTS)
- TypeScript ^5.3.3
- Express ^4.18.2
- Prisma ^5.7.1
- Build tool: tsc

**Frontend (apps/web):**
- Vue ^3.4.15
- Vite ^5.0.10
- TypeScript ^5.3.3
- vue-tsc ^1.8.27 (build-time type checking)
- Build tool: vite

**Build Orchestration:**
- Turborepo ^1.11.3 (monorepo build tool)
- npm workspaces for dependency management

### Critical Configuration Files to Review/Update
1. `/jiuguanbaba/cankao/tavernai-plus/.nvmrc` - Create with Node version
2. `/jiuguanbaba/cankao/tavernai-plus/package.json` - Update engines field
3. `/jiuguanbaba/cankao/tavernai-plus/apps/api/tsconfig.json` - TypeScript config
4. `/jiuguanbaba/cankao/tavernai-plus/apps/web/tsconfig.json` - Vue TypeScript config
5. `/jiuguanbaba/cankao/tavernai-plus/apps/web/vite.config.ts` - Vite build config
6. `/jiuguanbaba/cankao/tavernai-plus/turbo.json` - Turbo build pipeline
7. `/jiuguanbaba/cankao/tavernai-plus/Dockerfile` - Docker build instructions

### Build Commands (from package.json scripts)
```bash
# From root directory:
npm install          # Install all dependencies
npm run build        # Build all apps via Turbo
npm run dev          # Run all apps in dev mode

# Individual app builds:
cd apps/api && npm run build    # Builds to dist/
cd apps/web && npm run build    # Builds to dist/
```

### Known Working Versions (to target)
- Node.js: 18.20.4 (latest 18.x LTS)
- npm: 10.x (comes with Node 18)
- TypeScript: 5.3.3 (already specified)
- Vite: 5.0.10 (already specified)
- vue-tsc: 1.8.27 (already specified but failing)

### Testing Standards
Since no formal architecture docs exist yet, follow these minimal testing requirements:

#### Test File Location
- API tests: `apps/api/tests/` or `apps/api/src/**/*.test.ts`
- Web tests: `apps/web/tests/` or `apps/web/src/**/*.test.ts`

#### Test Standards
- Verify build commands complete without errors
- Ensure build outputs are created in dist/ directories
- Test that built applications can start successfully
- Document all build commands in README

#### Testing Frameworks and Patterns
- API: Jest is configured in package.json
- Web: Vitest is configured in package.json
- For this story: Manual testing of build process is sufficient

#### Specific Testing Requirements for This Story
1. Test build on clean install (no node_modules)
2. Test build on multiple Node.js versions (18.x)
3. Test Docker build completes successfully
4. Test built applications can start and respond
5. Create build verification checklist for future use

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story draft created from Crisis Recovery PRD | Bob (SM) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*Pending*

### Debug Log References
*Pending*

### Completion Notes List
*Pending*

### File List
*Pending*

## QA Results
*To be populated after implementation*

---

## Story Handoff Notes

**Priority**: CRITICAL - This story blocks all other work

**Estimated Effort**: 4-8 hours

**Dependencies**: None - this is the first story

**Risks**: 
- Dependency conflicts may require additional package updates
- Some TypeScript errors may reveal deeper architectural issues
- Docker configuration may need significant rework

**Success Indicators**:
- `npm run build` completes with exit code 0
- No TypeScript errors reported
- Docker container builds and starts successfully
- All team members can build locally

**Next Steps After Completion**:
- Move to Story 1.2: Security Vulnerability Elimination
- Set up CI/CD pipeline with Node 18
- Document build process for new developers