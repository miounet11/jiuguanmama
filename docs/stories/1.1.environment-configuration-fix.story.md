# Story 1.1: 环境配置修复与系统启动

<!-- Source: Brownfield PRD Epic 1.1 -->
<!-- Context: Brownfield enhancement to TavernAI Plus 环境配置修复 -->

## Status: Draft

## Story

作为开发者，
我想要系统能够正常启动并提供完整的AI对话功能，
以便开始功能开发和测试工作。

## Context Source

- **Source Document**: Brownfield PRD Epic 1.1 + Architecture Document
- **Enhancement Type**: 环境配置修复与AI服务集成
- **Existing System Impact**: 修复阻塞性配置问题，恢复AI功能
- **LLM Configuration**: Grok-3 API (sk-ap3W4RSYQgxXsatCrAog6dZwYKnxs12rHcyokvjIkPmgGZuY, https://ttkk.inping.com/v1, model: grok-3)

## Acceptance Criteria

### AC1: Grok-3 LLM配置正确集成
- [x] **前置条件**: 用户已提供Grok-3 API配置信息
- [ ] 在 `apps/api/.env` 中正确配置 NEWAPI_KEY=sk-ap3W4RSYQgxXsatCrAog6dZwYKnxs12rHcyokvjIkPmgGZuY
- [ ] 配置 NEWAPI_BASE_URL=https://ttkk.inping.com/v1
- [ ] 配置 DEFAULT_MODEL=grok-3
- [ ] AI服务能够成功调用Grok-3 API并返回有效响应
- [ ] API密钥验证机制正常工作，无效密钥时有清晰错误提示

### AC2: 环境变量配置完整
- [ ] 开发环境 (.env.local) 配置完整
- [ ] 生产环境 (.env.production) 模板创建
- [ ] 测试环境 (.env.test) 配置完整
- [ ] 所有必需环境变量有默认值或清晰的文档说明
- [ ] 环境变量验证在应用启动时进行

### AC3: 前后端正常启动
- [ ] 后端 Express 服务在端口 5000 正常启动
- [ ] 前端 Vue 应用在端口 3000 正常启动
- [ ] WebSocket 连接稳定，实时通信功能正常
- [ ] 热重载功能在开发环境正常工作
- [ ] 构建过程无TypeScript错误

### AC4: 数据库连接正常
- [ ] Prisma 数据库连接成功
- [ ] 数据库迁移正常执行
- [ ] 种子数据正确加载
- [ ] 数据库查询性能在可接受范围内
- [ ] 数据库连接池配置正确

### AC5: 第三方服务连接测试
- [ ] OAuth 服务 (Google, Discord) 连接配置正确
- [ ] SMTP 邮件服务配置测试通过
- [ ] Redis 连接（如已配置）测试正常
- [ ] 所有外部服务连接有降级机制

## Integration Verification

### IV1: 现有用户认证功能保持正常
- [ ] 用户登录注册流程无影响
- [ ] JWT token 生成和验证正常
- [ ] 用户会话保持功能完整
- [ ] OAuth 登录流程保持稳定

### IV2: 现有API端点保持响应正常
- [ ] 所有现有 /api 端点响应正常
- [ ] API 响应时间无显著增加
- [ ] 错误处理机制保持一致
- [ ] API 文档保持准确

### IV3: 现有前端页面正常加载
- [ ] 所有现有页面正常渲染
- [ ] 前端路由系统正常工作
- [ ] 组件状态管理正常
- [ ] 无 JavaScript 控制台错误

## Dev Technical Guidance

### Existing System Context

**当前技术栈**:
- 前端：Vue 3.4 + Vite 6.0 + Element Plus 2.4 + TypeScript
- 后端：Node.js 18+ + Express 4.18 + Prisma ORM
- 数据库：SQLite (开发) / PostgreSQL (生产准备)
- 构建：Turbo Monorepo + npm workspaces

**关键配置文件**:
- `apps/api/.env` - 后端环境配置
- `apps/web/.env.development` - 前端开发配置
- `apps/api/src/services/ai.ts` - AI服务集成点
- `apps/api/src/server.ts` - 服务器入口点

### Integration Approach

**LLM 配置集成策略**:
1. 扩展现有 `apps/api/src/services/ai.ts` 服务
2. 在 `ai.ts` 中添加 Grok-3 提供商配置
3. 实现统一的 LLM 配置管理接口
4. 保持与现有 NewAPI 服务的兼容性

**环境配置策略**:
1. 使用现有的 dotenv 配置模式
2. 在 `apps/api/src/config/` 创建配置验证模块
3. 添加启动时配置检查
4. 实现配置缓存和热重载

### Technical Constraints

**必须保持的兼容性**:
- 现有 AI 服务调用接口不变
- Vue 组件对 AI 服务的调用方式保持一致
- WebSocket 消息格式保持兼容
- 数据库 schema 在此阶段不修改

**性能要求**:
- API 响应时间 < 200ms (不包括 LLM 调用)
- 前端首次加载时间 < 3秒
- WebSocket 连接延迟 < 50ms

**安全约束**:
- API 密钥不能暴露到前端
- 所有环境变量必须有验证
- 生产环境配置必须与开发环境分离

## Tasks / Subtasks

### Task 1: 分析现有 AI 服务实现
- [ ] 审查 `apps/api/src/services/ai.ts` 当前实现
- [ ] 了解现有 NewAPI 集成模式
- [ ] 识别与前端的集成接口
- [ ] 记录当前配置管理方式

### Task 2: 配置 Grok-3 LLM 服务
- [ ] 在 `.env` 文件中添加 Grok-3 配置
  ```
  NEWAPI_KEY=sk-ap3W4RSYQgxXsatCrAog6dZwYKnxs12rHcyokvjIkPmgGZuY
  NEWAPI_BASE_URL=https://ttkk.inping.com/v1
  DEFAULT_MODEL=grok-3
  NEWAPI_MAX_TOKENS=4000
  NEWAPI_TEMPERATURE=0.7
  ```
- [ ] 扩展 `ai.ts` 服务支持 Grok-3
- [ ] 实现 API 密钥验证机制
- [ ] 添加错误处理和重试逻辑

### Task 3: 完善环境配置管理
- [ ] 创建 `apps/api/src/config/env.config.ts` 配置验证模块
- [ ] 实现启动时环境变量检查
- [ ] 创建开发、测试、生产环境配置模板
- [ ] 添加配置文档说明

### Task 4: 验证系统启动流程
- [ ] 测试后端服务启动（`npm run dev:api`）
- [ ] 测试前端应用启动（`npm run dev:web`）
- [ ] 验证 WebSocket 连接稳定性
- [ ] 检查构建流程无错误

### Task 5: 数据库连接优化
- [ ] 验证 Prisma 连接配置
- [ ] 测试数据库迁移流程
- [ ] 确认种子数据加载正确
- [ ] 添加数据库健康检查

### Task 6: 第三方服务连接测试
- [ ] 验证 OAuth 配置正确性
- [ ] 测试邮件服务连接
- [ ] 配置服务降级机制
- [ ] 添加服务健康监控

### Task 7: 集成测试与验证
- [ ] 测试 AI 对话功能端到端流程
- [ ] 验证现有用户认证功能正常
- [ ] 检查所有现有 API 端点响应
- [ ] 确认前端页面正常加载

### Task 8: 文档更新
- [ ] 更新 README.md 环境配置说明
- [ ] 创建开发环境设置指南
- [ ] 记录故障排除常见问题
- [ ] 更新 API 文档（如有变更）

## Risk Assessment

### Implementation Risks

**Primary Risk**: Grok-3 API 配置错误可能导致所有 AI 功能不可用
- **Mitigation**: 实现优雅降级机制，API 调用失败时提供清晰错误信息
- **Verification**: 在无网络环境下测试错误处理是否正常

**Secondary Risk**: 环境变量配置错误可能影响系统启动
- **Mitigation**: 添加启动时配置验证，提供详细的错误信息指导
- **Verification**: 测试缺少关键环境变量时的错误提示

### Rollback Plan

如果配置出现问题：
1. 恢复 `.env` 文件到修改前状态
2. 重启应用服务
3. 检查 git 提交记录，回滚相关代码变更
4. 验证基本功能恢复正常

### Safety Checks

- [ ] 现有用户登录功能在配置前后测试通过
- [ ] AI 服务配置可以通过环境变量开关控制
- [ ] 所有配置变更都有对应的回滚操作文档

## Definition of Done

- [ ] Grok-3 AI 服务完全集成并正常工作
- [ ] 系统在开发和生产环境配置下都能正常启动
- [ ] 所有现有功能保持完整性
- [ ] 错误处理和降级机制完善
- [ ] 配置文档完整清晰
- [ ] 代码通过所有现有测试
- [ ] 集成测试验证新功能正常工作

---

**优先级**: 🔥 **最高优先级** - 这是解锁所有后续开发工作的基础故事