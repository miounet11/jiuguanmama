# TavernAI Plus 问题解决文档

## 文档说明
此文档记录开发过程中遇到的所有问题及其解决方案，作为后续开发的重要参考资料，防止反复修改导致出现错误。

## 开发核心原则
1. **生产就绪原则**: 整个开发过程以上线为目标，不使用模拟数据
2. **真实数据原则**: 数据库缺少内容时，生成真实的游戏数据（故事书、角色等）作为基础资料
3. **文档化原则**: 每次问题解决都要记录在此文档中

---

## 问题解决记录

### 2025-09-17

#### 问题1: 产品方向错误 - 误将AI角色扮演平台开发成工作流编辑器
**问题描述**: 
- 项目应该是"云酒馆"AI角色对话/角色扮演平台（类似Character.AI）
- 错误地开发成了工作流编辑器系统

**解决方案**:
1. 删除所有工作流相关文件和代码
2. 清理server.ts中的工作流路由引用
3. 重新聚焦于AI角色扮演平台功能

**影响文件**:
- `/apps/web/src/views/workflow/` (删除)
- `/apps/api/src/routes/workflow.ts` (删除)
- `/apps/api/src/server.ts` (清理工作流路由)

---

#### 问题2: 数据库配置不匹配
**问题描述**: 
- Prisma schema配置为PostgreSQL，但.env文件使用SQLite
- 导致PrismaClientInitializationError

**解决方案**:
1. 修改`prisma/schema.prisma`中datasource为sqlite
2. 将所有Json字段类型改为String（SQLite兼容性）
3. 重新生成Prisma客户端

**影响文件**:
- `/apps/api/prisma/schema.prisma`
- 所有包含Json字段的model定义

**代码示例**:
```prisma
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Json -> String
tags String // 之前是 tags Json
```

---

#### 问题3: 前端API端口配置错误
**问题描述**: 
- 前端请求端口3001，但API运行在端口3007
- 导致ERR_CONNECTION_REFUSED错误

**解决方案**:
1. 更新`.env.development`中的VITE_API_URL
2. 修改`api.ts`中的默认API_BASE_URL

**影响文件**:
- `/apps/web/.env.development`
- `/apps/web/src/services/api.ts`

**代码示例**:
```typescript
// .env.development
VITE_API_URL=http://localhost:3007

// api.ts
const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:3007'
```

---

#### 问题4: 缺少API端点导致404错误
**问题描述**: 
- 前端调用的API端点不存在：
  - `/api/characters/1/reviews`
  - `/api/characters/1/related`
  - `/api/characters/1` (单个角色详情)

**解决方案**:
1. 在`character.ts`路由中添加缺失的端点
2. ⚠️ **错误做法**: 使用模拟数据返回
3. ✅ **正确做法**: 应该生成真实的种子数据

**影响文件**:
- `/apps/api/src/routes/character.ts`

**注意**: 此解决方案需要重构，应使用真实数据库数据而非模拟数据

---

#### 问题5: TypeScript类型错误阻止API启动
**问题描述**: 
- `chatroom.ts`: permissions字段类型不匹配（期望string，传入object）
- `character-ai.ts`: 多个类型兼容性问题

**解决方案**:
1. 修复permissions字段：`JSON.stringify({})`
2. 修复message role类型限制
3. 添加必需的sessionId和userId参数

**当前状态**: 正在解决中

**影响文件**:
- `/apps/api/src/services/chatroom.ts`
- `/apps/api/src/services/character-ai.ts`

---

## 待解决问题

### 高优先级
1. **TypeScript类型错误**: 完成character-ai.ts中的类型修复
2. **移除模拟数据**: 将所有模拟数据替换为真实数据库查询
3. **数据库种子数据**: 创建真实的角色、故事数据作为基础内容

### 中优先级
1. **UI界面完善**: 完成司夜角色详情页面的最终调整
2. **用户认证**: 修复401认证错误
3. **性能优化**: 优化API响应速度

---

## 开发规范

### 数据原则
- ❌ 不使用模拟数据
- ✅ 生成真实的游戏内容作为种子数据
- ✅ 所有功能基于真实数据库操作

### 代码原则
- 每次修改前先理解现有代码结构
- 遵循项目现有的代码风格和架构
- 所有修改都要在此文档中记录

### 测试原则
- 以生产环境标准进行开发
- 确保所有功能在真实数据下正常工作
- 定期验证整体系统功能

---

## 更新日志
- 2025-09-17: 创建文档，记录前期所有问题解决方案
- 下次更新: TypeScript错误修复完成后