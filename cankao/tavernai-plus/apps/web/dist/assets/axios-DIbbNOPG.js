var p=Object.defineProperty;var d=(t,e,r)=>e in t?p(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var c=(t,e,r)=>d(t,typeof e!="symbol"?e+"":e,r);import{G as m,k as u,E as o,H as g}from"./index-Dgends3d.js";class E{constructor(){c(this,"logs",[]);c(this,"maxLogs",500);c(this,"storageKey","frontend_error_logs");this.loadLogs(),this.setupGlobalErrorHandlers()}setupGlobalErrorHandlers(){window.addEventListener("error",e=>{var r;this.error(`Uncaught Error: ${e.message}`,{page:window.location.pathname,stack:(r=e.error)==null?void 0:r.stack,action:"global_error"})}),window.addEventListener("unhandledrejection",e=>{var r;this.error(`Unhandled Promise Rejection: ${e.reason}`,{page:window.location.pathname,stack:(r=e.reason)==null?void 0:r.stack,action:"promise_rejection"})})}loadLogs(){try{const e=localStorage.getItem(this.storageKey);e&&(this.logs=JSON.parse(e))}catch{console.error("Failed to load error logs from storage")}}saveLogs(){try{this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs)),localStorage.setItem(this.storageKey,JSON.stringify(this.logs))}catch{console.error("Failed to save error logs to storage")}}log(e){const r={timestamp:new Date().toISOString(),level:e.level||"ERROR",page:window.location.pathname,userAgent:navigator.userAgent,userId:this.getCurrentUserId(),...e};this.logs.push(r),this.saveLogs(),r.level==="ERROR"&&this.sendToBackend(r)}getCurrentUserId(){const e=localStorage.getItem("user");if(e)try{return JSON.parse(e).id}catch{return}}async sendToBackend(e){try{await fetch("/api/logs/frontend",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch{}}error(e,r){this.log({level:"ERROR",message:e,...r})}warn(e,r){this.log({level:"WARN",message:e,...r})}info(e,r){this.log({level:"INFO",message:e,...r})}apiError(e,r,n,i){this.error(`API Error: ${r} ${e} - ${n}`,{action:"api_call",component:"api",page:window.location.pathname})}componentError(e,r){this.error(`Component Error in ${e}: ${r.message}`,{component:e,stack:r.stack,action:"component_error"})}getRecentLogs(e=100){return this.logs.slice(-e)}getErrorSummary(){const e=this.logs.filter(s=>s.level==="ERROR"),r=new Date(Date.now()-1440*60*1e3),n=e.filter(s=>new Date(s.timestamp)>r),i={},l={};return n.forEach(s=>{s.page&&(i[s.page]=(i[s.page]||0)+1),s.component&&(l[s.component]=(l[s.component]||0)+1)}),{totalErrors:e.length,last24hErrors:n.length,pageErrors:i,componentErrors:l,lastError:e[e.length-1]}}clearLogs(){this.logs=[],this.saveLogs()}exportLogs(){return JSON.stringify(this.logs,null,2)}}const w=new E,a=m.create({baseURL:"http://localhost:3001",timeout:3e4,headers:{"Content-Type":"application/json"}});a.interceptors.request.use(t=>{const e=u();return e.token&&(t.headers=t.headers||{},t.headers.Authorization=`Bearer ${e.token}`),t},t=>(console.error("Request error:",t),Promise.reject(t)));a.interceptors.response.use(t=>t.data,async t=>{var n,i,l;const{response:e,config:r}=t;if(e&&w.apiError((r==null?void 0:r.url)||"unknown",((n=r==null?void 0:r.method)==null?void 0:n.toUpperCase())||"GET",e.status,((i=e.data)==null?void 0:i.message)||"Request failed"),e)switch(e.status){case 401:u().logout();const h=g.currentRoute.value.fullPath;h!=="/login"&&g.push({path:"/login",query:{redirect:h}}),o.error("登录已过期，请重新登录");break;case 403:o.error("没有权限访问该资源");break;case 404:o.error("请求的资源不存在");break;case 429:o.error("请求过于频繁，请稍后再试");break;case 500:o.error("服务器错误，请稍后再试");break;default:o.error(((l=e.data)==null?void 0:l.message)||"请求失败")}else t.code==="ECONNABORTED"?o.error("请求超时，请检查网络连接"):t.message==="Network Error"?o.error("网络错误，请检查网络连接"):o.error("请求失败，请稍后再试");return Promise.reject(t)});const k={get:(t,e)=>a.get(t,e),post:(t,e,r)=>a.post(t,e,r),put:(t,e,r)=>a.put(t,e,r),patch:(t,e,r)=>a.patch(t,e,r),delete:(t,e)=>a.delete(t,e),upload:(t,e,r)=>a.post(t,e,{...r,headers:{"Content-Type":"multipart/form-data",...r==null?void 0:r.headers}})};export{w as e,k as h,a as i};
