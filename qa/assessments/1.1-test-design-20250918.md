# Test Design: Story 1.1 - 多模型AI支持

Date: 2025-09-18
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- Unit tests: 10 (42%)
- Integration tests: 8 (33%)
- E2E tests: 6 (25%)
- Priority distribution: P0: 8, P1: 10, P2: 6

## Story Context

**Epic:** TavernAI Plus 核心功能开发
**Story:** 实现多模型AI支持，允许用户在不同AI模型间切换
**Files Tested:**
- `/apps/api/src/services/ai.ts` - AI服务核心逻辑
- `/apps/api/src/routes/models.ts` - 模型管理API
- `/apps/web/src/components/common/ModelSelector.vue` - 模型选择器组件
- `/apps/web/src/views/chat/ChatSession.vue` - 聊天界面集成

## Test Scenarios by Acceptance Criteria

### AC1: 系统支持5种AI模型配置和管理

#### Scenarios

| ID            | Level       | Priority | Test                                    | Justification                |
| ------------- | ----------- | -------- | --------------------------------------- | ---------------------------- |
| 1.1-UNIT-001  | Unit        | P0       | 验证SUPPORTED_MODELS配置完整性          | 静态配置验证，纯数据校验     |
| 1.1-UNIT-002  | Unit        | P0       | getModelConfig返回正确模型配置          | 核心方法逻辑，无外部依赖     |
| 1.1-UNIT-003  | Unit        | P1       | getSupportedModels返回所有可用模型      | 基础查询功能                 |
| 1.1-INT-001   | Integration | P0       | /api/models API端点返回模型列表         | API层与服务层交互            |
| 1.1-INT-002   | Integration | P1       | /api/models/:id API端点返回特定模型配置 | API路由参数处理              |
| 1.1-E2E-001   | E2E         | P1       | 用户可在界面查看所有支持的模型          | 关键用户体验验证             |

### AC2: 模型可用性验证机制

#### Scenarios

| ID            | Level       | Priority | Test                                  | Justification                    |
| ------------- | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.1-UNIT-004  | Unit        | P1       | validateModel对无效模型返回false      | 边界条件测试，纯逻辑验证         |
| 1.1-INT-003   | Integration | P0       | validateModel成功验证可用模型         | 涉及外部API调用，需集成测试      |
| 1.1-INT-004   | Integration | P0       | validateModel处理API连接失败          | 错误处理逻辑，需模拟外部失败     |
| 1.1-INT-005   | Integration | P1       | 批量验证API正确处理并发验证请求       | 并发处理和Promise.allSettled测试 |
| 1.1-E2E-002   | E2E         | P1       | 用户可手动验证模型可用性              | 用户操作验证流程                 |

### AC3: 模型选择器组件功能

#### Scenarios

| ID            | Level       | Priority | Test                                    | Justification                  |
| ------------- | ----------- | -------- | --------------------------------------- | ------------------------------ |
| 1.1-UNIT-005  | Unit        | P1       | ModelSelector正确分组显示模型           | Vue组件计算属性逻辑            |
| 1.1-UNIT-006  | Unit        | P1       | 选择模型时触发change事件                | 组件事件处理逻辑               |
| 1.1-UNIT-007  | Unit        | P2       | 组件正确显示模型详情和标签              | UI状态计算逻辑                 |
| 1.1-INT-006   | Integration | P1       | ModelSelector与API正确交互获取模型列表  | 组件与API服务集成              |
| 1.1-E2E-003   | E2E         | P0       | 用户可通过下拉框选择不同模型            | 核心用户交互流程               |
| 1.1-E2E-004   | E2E         | P1       | 选择模型后聊天设置自动调整              | 模型切换后的联动效果           |

### AC4: 聊天界面模型集成

#### Scenarios

| ID            | Level       | Priority | Test                                  | Justification                    |
| ------------- | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.1-UNIT-008  | Unit        | P1       | onModelChange正确更新设置参数         | 纯函数逻辑，参数调整算法         |
| 1.1-UNIT-009  | Unit        | P2       | 模型配置超出范围时的参数裁剪逻辑      | 边界值处理逻辑                   |
| 1.1-INT-007   | Integration | P0       | 不同模型的聊天请求格式正确            | 模型差异化处理集成               |
| 1.1-INT-008   | Integration | P0       | 模型切换后新消息使用正确的模型        | 状态管理和API调用集成            |
| 1.1-E2E-005   | E2E         | P0       | 用户切换模型后可正常进行对话          | 端到端用户工作流验证             |
| 1.1-E2E-006   | E2E         | P2       | 模型切换过程中的错误处理和用户反馈    | 异常场景的用户体验               |

### AC5: 错误处理和用户反馈

#### Scenarios

| ID            | Level       | Priority | Test                                  | Justification                |
| ------------- | ----------- | -------- | ------------------------------------- | ---------------------------- |
| 1.1-UNIT-010  | Unit        | P1       | 无效模型ID的错误处理                  | 异常分支覆盖                 |
| 1.1-INT-009   | Integration | P1       | API错误响应的统一处理                 | 错误处理中间件测试           |

## Risk Coverage

### 高风险场景
- **RISK-001**: 模型不可用导致服务中断 → 1.1-INT-003, 1.1-INT-004
- **RISK-002**: 模型切换导致对话中断 → 1.1-E2E-005, 1.1-INT-008
- **RISK-003**: 并发验证请求导致API过载 → 1.1-INT-005

### 中风险场景
- **RISK-004**: 配置错误导致模型无法加载 → 1.1-UNIT-001, 1.1-UNIT-002
- **RISK-005**: UI状态不同步 → 1.1-E2E-004, 1.1-UNIT-005

## Test Implementation Strategy

### 单元测试 (Unit Tests)
**框架**: Jest + Vue Test Utils
**重点**: 纯函数逻辑、数据处理、组件状态管理

```javascript
// 示例: 1.1-UNIT-001
describe('SUPPORTED_MODELS configuration', () => {
  test('should contain all required model properties', () => {
    Object.values(SUPPORTED_MODELS).forEach(model => {
      expect(model).toHaveProperty('id')
      expect(model).toHaveProperty('name')
      expect(model).toHaveProperty('provider')
      expect(model).toHaveProperty('maxTokens')
      expect(model.maxTokens).toBeGreaterThan(0)
    })
  })
})
```

### 集成测试 (Integration Tests)
**框架**: Jest + Supertest + Test Database
**重点**: API端点、服务交互、外部依赖

```javascript
// 示例: 1.1-INT-001
describe('GET /api/models', () => {
  test('should return list of supported models', async () => {
    const response = await request(app)
      .get('/api/models')
      .expect(200)
    
    expect(response.body.success).toBe(true)
    expect(Array.isArray(response.body.data)).toBe(true)
    expect(response.body.data).toHaveLength(5)
  })
})
```

### E2E测试 (End-to-End Tests)
**框架**: Playwright + Test Environment
**重点**: 用户工作流、界面交互、完整场景

```javascript
// 示例: 1.1-E2E-003
test('user can select different AI models', async ({ page }) => {
  await page.goto('/chat/test-character')
  await page.click('[data-testid="settings-button"]')
  await page.click('[data-testid="model-selector"]')
  await page.click('text=GPT-4')
  
  await expect(page.locator('[data-testid="selected-model"]')).toContainText('GPT-4')
  await expect(page.locator('[data-testid="success-message"]')).toContainText('已切换到 GPT-4')
})
```

## Recommended Execution Order

### Phase 1: 快速反馈 (P0 Unit)
1. 1.1-UNIT-001 - 配置完整性验证
2. 1.1-UNIT-002 - 核心方法逻辑

### Phase 2: 核心集成 (P0 Integration)
3. 1.1-INT-001 - 模型列表API
4. 1.1-INT-003 - 模型验证成功
5. 1.1-INT-004 - 模型验证失败处理
6. 1.1-INT-007 - 不同模型请求格式
7. 1.1-INT-008 - 模型切换状态管理

### Phase 3: 关键用户路径 (P0 E2E)
8. 1.1-E2E-003 - 模型选择交互
9. 1.1-E2E-005 - 模型切换后对话

### Phase 4: 重要功能 (P1)
10. 1.1-UNIT-003 到 1.1-UNIT-006 - 组件逻辑
11. 1.1-INT-002, 1.1-INT-005, 1.1-INT-006 - API和组件集成
12. 1.1-E2E-001, 1.1-E2E-002, 1.1-E2E-004 - 用户体验

### Phase 5: 次要功能 (P2)
13. 剩余P2测试（时间允许时执行）

## Test Data Requirements

### 模型配置测试数据
```yaml
test_models:
  valid_model:
    id: "test-gpt-4"
    name: "Test GPT-4"
    provider: "openai"
    maxTokens: 8000
    temperature: 0.7
  
  invalid_model:
    id: "invalid-model"
    # 缺少必要字段

mock_responses:
  validation_success:
    status: 200
    data: { choices: [{ message: { content: "Hi" } }] }
  
  validation_failure:
    status: 401
    error: "Invalid API key"
```

## Quality Gates

### 测试覆盖率要求
- 单元测试覆盖率: ≥ 90%
- 集成测试: 所有API端点覆盖
- E2E测试: 所有P0和P1用户流程覆盖

### 性能要求
- 模型列表API响应时间: < 200ms
- 模型验证响应时间: < 5s
- 模型切换界面响应: < 100ms

### 可靠性要求
- 所有P0测试必须通过
- P1测试通过率 ≥ 95%
- 无P0级别的安全或数据完整性问题

## Maintenance Strategy

### 测试维护原则
1. **版本控制**: 模型配置变更时更新相应测试
2. **数据清理**: 每次测试运行后清理测试数据
3. **Mock管理**: 定期更新外部API mock响应
4. **测试审查**: 每次功能变更后审查测试覆盖

### 持续集成
- 每次PR必须通过所有P0测试
- 夜间构建运行完整测试套件
- 生产部署前运行完整E2E测试

---

**总计**: 24个测试场景，覆盖所有关键功能和风险场景
**预估执行时间**: 完整测试套件 ~45分钟
**维护工作量**: 低-中等（主要是配置和数据同步）