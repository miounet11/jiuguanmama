---
name: 角色剧本关联系统
status: open
created: 2025-09-22T13:12:00Z
updated: 
github: https://github.com//issues/25
depends_on: [22, 23]
parallel: true
conflicts_with: []
---

# Task: 角色剧本关联系统

## Description

实现角色与剧本的关联绑定系统，支持一对一和一对多关联关系。开发关联管理界面，实现继承策略配置，确保在对话创建时能自动加载相关的世界信息剧本。

## Acceptance Criteria

- [ ] 扩展Character模型，添加剧本关联字段
- [ ] 实现角色剧本关联API: POST/DELETE /api/characters/:id/scenarios
- [ ] 支持一对一和一对多关联关系，设置优先级
- [ ] 实现继承策略：角色优先、均匀排序、分层注入
- [ ] 在角色编辑界面添加剧本选择器组件
- [ ] 在对话创建时自动加载角色关联的剧本
- [ ] 支持对话中动态启用/禁用特定剧本
- [ ] 添加全局剧本支持，所有对话可用的通用世界信息
- [ ] 实现剧本加载缓存，提升对话启动性能

## Technical Details

### 数据库关联设计
```prisma
model Character {
  // 现有字段...
  scenarios ScenarioCharacter[]
}

model ScenarioCharacter {
  characterId String
  scenarioId  String
  priority    Int     @default(0)
  isActive    Boolean @default(true)

  character Character @relation(fields: [characterId], references: [id])
  scenario  Scenario  @relation(fields: [scenarioId], references: [id])

  @@id([characterId, scenarioId])
}
```

### API设计
```typescript
// 角色剧本关联管理
POST   /api/characters/:id/scenarios           # 关联剧本到角色
DELETE /api/characters/:id/scenarios/:scenarioId # 移除角色剧本关联
PUT    /api/characters/:id/scenarios/:scenarioId # 更新关联配置 (优先级等)
GET    /api/characters/:id/scenarios           # 获取角色关联的剧本列表

// 对话世界信息管理
GET    /api/chats/:id/world-info              # 获取对话的活跃世界信息
POST   /api/chats/:id/world-info/toggle       # 动态启用/禁用剧本
```

### 文件影响
- `cankao/tavernai-plus/apps/api/prisma/schema.prisma` - 数据模型扩展
- `cankao/tavernai-plus/apps/api/src/routes/characters.ts` - 角色API扩展
- `cankao/tavernai-plus/apps/api/src/services/characterScenarioService.ts` - 关联业务逻辑
- `cankao/tavernai-plus/apps/web/src/components/character/ScenarioSelector.vue` - 剧本选择器
- `cankao/tavernai-plus/apps/web/src/views/chat/ChatSession.vue` - 对话界面集成

### 继承策略实现
```typescript
interface InheritanceStrategy {
  type: 'character_first' | 'uniform_sort' | 'layered_injection';
  globalScenariosEnabled: boolean;
  maxActiveScenarios: number;
}

class ScenarioInheritanceManager {
  resolveActiveScenarios(
    characterId: string,
    chatId: string,
    strategy: InheritanceStrategy
  ): Promise<Scenario[]>
}
```

## Dependencies

- [ ] Task 003: 剧本管理API开发 (依赖剧本数据模型)
- [ ] Task 004: 世界信息注入系统 (依赖注入机制)
- [ ] 现有角色管理系统
- [ ] 现有对话引擎和聊天界面

## Effort Estimate

- **Size**: M (Medium)
- **Hours**: 24-32小时
- **Parallel**: true (可与前端开发并行进行)

## Definition of Done

- [ ] 代码实现: 完整的关联系统和继承策略
- [ ] 测试通过: 关联功能和继承逻辑测试
- [ ] 文档更新: 关联配置文档和使用指南
- [ ] 代码审查: 通过数据一致性和性能审查
- [ ] 功能验证: 在真实对话场景中验证关联效果
