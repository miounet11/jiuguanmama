---
name: 世界信息注入系统
status: open
created: 2025-09-22T13:12:00Z
updated: 
github: https://github.com//issues/23
depends_on: [21, 22]
parallel: false
conflicts_with: []
---

# Task: 世界信息注入系统

## Description

实现世界信息到AI对话prompt的动态注入系统。集成到现有对话引擎中，支持多AI模型的prompt格式适配，实现token预算管理和插入位置控制，确保世界信息的有效注入不影响对话性能。

## Acceptance Criteria

- [ ] 实现PromptInjector核心类，支持世界信息注入
- [ ] 集成到现有对话引擎的prompt构建流程
- [ ] 支持多AI模型的prompt格式适配 (OpenAI, Claude, Gemini等)
- [ ] 实现token预算管理，避免超出模型限制
- [ ] 支持多种插入位置：角色定义前后、示例消息前后、指定深度
- [ ] 实现动态长度调整，根据对话历史智能控制注入量
- [ ] 添加实时缓存，提升注入性能
- [ ] 世界信息注入延迟 < 200ms (95th percentile)
- [ ] 完整的集成测试，验证多模型兼容性

## Technical Details

### 核心注入架构
```typescript
interface InjectionConfig {
  position: 'before_character' | 'after_character' | 'before_examples' | 'after_examples' | 'at_depth';
  depth?: number;
  maxTokens: number;
  priority: number;
}

class PromptInjector {
  injectWorldInfo(
    prompt: string,
    scenarioId: string,
    context: string,
    config: InjectionConfig
  ): Promise<string>

  calculateTokenUsage(content: string, model: string): number
  optimizeForModel(content: string, modelType: string): string
}
```

### 文件影响
- `cankao/tavernai-plus/apps/api/src/services/promptInjector.ts` - 核心注入器
- `cankao/tavernai-plus/apps/api/src/services/aiService.ts` - AI服务集成
- `cankao/tavernai-plus/apps/api/src/utils/tokenCounter.ts` - Token计算工具
- `cankao/tavernai-plus/apps/api/src/types/prompt.ts` - Prompt类型定义

### AI模型适配策略
- **OpenAI**: System message + User context + World info
- **Claude**: Human/Assistant格式 + 世界信息前置
- **Gemini**: Parts数组格式 + 分段注入
- **统一接口**: 模型无关的注入逻辑

### 性能优化
- 世界信息预处理和缓存
- Token计算结果缓存
- 异步注入处理
- 内存使用优化

## Dependencies

- [ ] Task 002: 关键词匹配引擎实现 (依赖匹配算法)
- [ ] Task 003: 剧本管理API开发 (依赖数据获取)
- [ ] 现有AI服务和对话引擎
- [ ] Token计算库 (tiktoken等)

## Effort Estimate

- **Size**: L (Large)
- **Hours**: 32-40小时
- **Parallel**: false (依赖多个前置任务)

## Definition of Done

- [ ] 代码实现: 完整的注入系统和模型适配
- [ ] 测试通过: 多模型集成测试和性能测试
- [ ] 文档更新: 注入机制文档和配置指南
- [ ] 代码审查: 通过性能和兼容性审查
- [ ] 生产验证: 在真实AI对话中验证效果
