---
name: 剧本管理API开发
status: open
created: 2025-09-22T13:12:00Z
updated: 
github: https://github.com//issues/22
depends_on: [20]
parallel: true
conflicts_with: [004]
---

# Task: 剧本管理API开发

## Description

开发完整的剧本管理RESTful API接口，包括剧本和世界信息条目的CRUD操作。实现用户权限验证、数据验证、错误处理等完整的业务逻辑，确保API的安全性和可靠性。

## Acceptance Criteria

- [ ] 实现剧本CRUD API: POST/GET/PUT/DELETE /api/scenarios
- [ ] 实现世界信息条目API: POST/PUT/DELETE /api/scenarios/:id/entries
- [ ] 添加用户权限验证，确保用户只能操作自己的剧本
- [ ] 实现数据验证，使用Zod schema验证请求数据
- [ ] 添加统一的错误处理和响应格式
- [ ] 实现关键词匹配测试API: POST /api/scenarios/:id/test
- [ ] 支持分页查询和高级筛选功能
- [ ] API响应时间 < 200ms (95th percentile)
- [ ] 完整的API集成测试覆盖

## Technical Details

### API路由设计
```typescript
// 剧本管理
POST   /api/scenarios              # 创建剧本
GET    /api/scenarios              # 获取剧本列表 (支持分页、筛选)
GET    /api/scenarios/:id          # 获取剧本详情
PUT    /api/scenarios/:id          # 更新剧本
DELETE /api/scenarios/:id          # 删除剧本

// 世界信息条目管理
POST   /api/scenarios/:id/entries          # 添加条目
PUT    /api/scenarios/:id/entries/:entryId # 更新条目
DELETE /api/scenarios/:id/entries/:entryId # 删除条目

// 测试和工具
POST   /api/scenarios/:id/test     # 测试关键词匹配
```

### 文件影响
- `cankao/tavernai-plus/apps/api/src/routes/scenarios.ts` - 主路由文件
- `cankao/tavernai-plus/apps/api/src/services/scenarioService.ts` - 业务逻辑
- `cankao/tavernai-plus/apps/api/src/middleware/validation.ts` - 数据验证中间件
- `cankao/tavernai-plus/apps/api/src/types/api.ts` - API类型定义

### 验证策略
```typescript
const createScenarioSchema = z.object({
  name: z.string().min(1).max(100),
  description: z.string().optional(),
  isPublic: z.boolean().default(false),
  tags: z.array(z.string()).default([])
});

const worldInfoEntrySchema = z.object({
  title: z.string().min(1).max(200),
  content: z.string().min(1),
  keywords: z.array(z.string()),
  priority: z.number().int().min(0).max(999),
  isActive: z.boolean().default(true)
});
```

## Dependencies

- [ ] Task 001: 数据库架构设计和迁移 (依赖数据模型)
- [ ] 现有用户认证中间件
- [ ] Zod验证库和中间件配置
- [ ] Express路由和错误处理基础设施

## Effort Estimate

- **Size**: M (Medium)
- **Hours**: 24-32小时
- **Parallel**: true (可与关键词匹配引擎并行开发)

## Definition of Done

- [ ] 代码实现: 完整的API接口和业务逻辑
- [ ] 测试通过: API集成测试和端到端测试
- [ ] 文档更新: API文档和使用示例
- [ ] 代码审查: 通过安全和性能审查
- [ ] 环境部署: 在测试环境验证功能
