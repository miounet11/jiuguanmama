---
name: 数据库架构设计和迁移
status: open
created: 2025-09-22T13:12:00Z
updated: 2025-09-23T01:00:46Z
github: https://github.com/miounet11/jiuguanbaba/issues/20
depends_on: []
parallel: false
conflicts_with: []
---

# Task: 数据库架构设计和迁移

## Description

设计并实现情景剧本与世界信息系统的数据库架构。基于现有Prisma schema扩展，新增Scenario和WorldInfoEntry模型，建立完整的关系映射，并创建相应的数据库迁移脚本和索引优化。

## Acceptance Criteria

- [ ] 完成Prisma schema设计，定义Scenario和WorldInfoEntry模型
- [ ] 建立与现有User和Character模型的关联关系
- [ ] 创建数据库迁移脚本，支持向后兼容
- [ ] 实现关键词字段的全文索引和B-tree索引
- [ ] 添加数据约束和验证规则
- [ ] 编写种子数据生成脚本，创建示例剧本
- [ ] 通过所有数据库集成测试

## Technical Details

### Schema设计要点
- **Scenario模型**: id, name, description, userId, isPublic, tags, createdAt, updatedAt
- **WorldInfoEntry模型**: id, scenarioId, title, content, keywords[], priority, insertDepth, isActive, matchType, probability
- **关联关系**: User(1) → Scenario(n), Scenario(1) → WorldInfoEntry(n), Character(n) ↔ Scenario(n)

### 文件影响
- `cankao/tavernai-plus/apps/api/prisma/schema.prisma` - 模型定义
- `cankao/tavernai-plus/apps/api/prisma/migrations/` - 迁移脚本目录
- `cankao/tavernai-plus/apps/api/prisma/seed.ts` - 种子数据扩展

### 索引策略
- WorldInfoEntry.keywords - 全文索引，支持关键词搜索
- WorldInfoEntry.scenarioId + priority - 复合索引，优化查询性能
- Scenario.userId + isPublic - 复合索引，支持用户权限过滤

## Dependencies

- [ ] 现有Prisma ORM和数据库连接配置
- [ ] TypeScript类型生成工具链
- [ ] 数据库迁移和种子数据脚本执行环境

## Effort Estimate

- **Size**: M (Medium)
- **Hours**: 24-32小时
- **Parallel**: false (基础设施任务，其他任务依赖此任务)

## Definition of Done

- [ ] 代码实现: Prisma schema和迁移脚本完成
- [ ] 测试通过: 数据库操作和关联查询测试
- [ ] 文档更新: 数据库设计文档和API类型定义
- [ ] 代码审查: 通过代码审查和安全检查
- [ ] 环境部署: 在开发和测试环境验证迁移
