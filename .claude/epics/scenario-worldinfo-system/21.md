---
name: 关键词匹配引擎实现
status: open
created: 2025-09-22T13:12:00Z
updated: 
github: https://github.com//issues/21
depends_on: [20]
parallel: false
conflicts_with: []
---

# Task: 关键词匹配引擎实现

## Description

实现高性能的关键词匹配引擎，支持精确匹配、模糊匹配、正则表达式匹配多种策略。兼容SillyTavern的关键词语法，支持复杂的逻辑操作（AND/OR/NOT），并提供递归扫描和条目关联激活功能。

## Acceptance Criteria

- [ ] 实现WorldInfoMatcher核心类，支持多种匹配模式
- [ ] 支持SillyTavern兼容的关键词语法（正则表达式、通配符等）
- [ ] 实现复杂逻辑操作：AND ANY、AND ALL、NOT ANY、NOT ALL
- [ ] 支持递归扫描机制，条目间关联激活
- [ ] 实现优先级排序和插入位置控制
- [ ] 添加性能优化：结果缓存、查询优化
- [ ] 关键词匹配延迟 < 100ms (95th percentile)
- [ ] 完整的单元测试覆盖，测试覆盖率 ≥ 90%

## Technical Details

### 核心算法设计
```typescript
interface MatchConfig {
  matchType: 'keyword' | 'regex' | 'semantic';
  caseSensitive: boolean;
  wholeWord: boolean;
  logicOperator: 'AND_ANY' | 'AND_ALL' | 'NOT_ANY' | 'NOT_ALL';
}

class WorldInfoMatcher {
  matchKeywords(content: string, keywords: string[], config: MatchConfig): boolean
  findActiveEntries(scenarioId: string, context: string, depth?: number): WorldInfoEntry[]
  calculatePriority(entry: WorldInfoEntry, matches: string[]): number
}
```

### 文件影响
- `cankao/tavernai-plus/apps/api/src/services/worldInfoMatcher.ts` - 核心匹配引擎
- `cankao/tavernai-plus/apps/api/src/types/worldInfo.ts` - 类型定义
- `cankao/tavernai-plus/apps/api/src/utils/regexHelpers.ts` - 正则表达式工具

### 性能优化策略
- 关键词预处理和索引缓存
- 正则表达式编译缓存
- 匹配结果的LRU缓存
- 递归深度限制防止无限循环

## Dependencies

- [ ] Task 001: 数据库架构设计和迁移 (依赖数据模型)
- [ ] 正则表达式处理库
- [ ] 缓存管理基础设施

## Effort Estimate

- **Size**: L (Large)
- **Hours**: 32-40小时
- **Parallel**: false (核心算法，后续功能依赖此任务)

## Definition of Done

- [ ] 代码实现: 完整的匹配引擎和算法实现
- [ ] 测试通过: 各种匹配场景的单元测试和性能测试
- [ ] 文档更新: 匹配算法文档和使用指南
- [ ] 代码审查: 通过性能和安全审查
- [ ] 性能验证: 达到性能基准要求
