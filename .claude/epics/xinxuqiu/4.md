---
id: "TASK-XINXUQIU-003"
title: "角色系统升级"
epic: "xinxuqiu"
description: "升级角色系统UI，实现现代化卡片式展示、创建器优化、瀑布流布局和@语法支持"
type: "feature"
priority: "high"
status: "todo"
assignee: ""
created: "2025-09-19T08:33:11Z"
updated: 2025-09-19T08:50:02Z
estimated_hours: 32
actual_hours: 0
depends_on: ["TASK-XINXUQIU-001", "TASK-XINXUQIU-002"]
parallel: []
tags: ["character", "ui", "cards", "masonry", "creator"]
---

# 角色系统升级

## 概述

基于新设计系统全面升级角色系统UI，实现现代化的卡片式展示、优化角色创建器体验、构建瀑布流布局系统，并集成@语法支持，打造业界领先的角色管理体验。

## 目标

- 设计现代化角色卡片，提升视觉吸引力
- 优化角色创建器，简化创建流程
- 实现Pinterest式瀑布流布局
- 集成@语法快速角色引用系统
- 建立角色标签和分类体系
- 支持角色快速预览和操作

## 技术要求

### 角色卡片设计
- 响应式卡片布局，支持多种尺寸
- 角色头像、名称、描述的优雅展示
- 交互状态动画和悬停效果
- 快速操作菜单（喜欢、分享、聊天）
- 角色统计信息展示

### 瀑布流布局
- 虚拟化瀑布流，支持大量数据
- 自适应列数，响应屏幕尺寸
- 无限滚动加载
- 卡片高度自适应内容
- 流畅的加载动画

### 角色创建器
- 分步骤创建流程
- 实时预览功能
- 拖拽上传头像
- AI辅助生成选项
- 模板快速创建

### @语法支持
- 角色名称自动补全
- 智能搜索和过滤
- 快速插入角色引用
- 语法高亮显示

## 实施细节

### 1. 现代化角色卡片组件
```vue
<template>
  <div
    :class="[
      'character-card',
      `character-card--${size}`,
      { 'character-card--interactive': interactive }
    ]"
    @click="handleCardClick"
  >
    <!-- 角色头像区域 -->
    <div class="character-avatar-section">
      <div class="character-avatar-container">
        <img
          :src="character.avatar || defaultAvatar"
          :alt="character.name"
          class="character-avatar"
          @load="handleImageLoad"
          @error="handleImageError"
        />

        <!-- 在线状态指示器 -->
        <div
          v-if="showOnlineStatus && character.isOnline"
          class="online-indicator"
        />
      </div>

      <!-- 快速操作按钮 -->
      <div class="character-actions" v-if="showActions">
        <el-button
          circle
          size="small"
          :type="character.isLiked ? 'danger' : 'default'"
          @click.stop="handleToggleLike"
        >
          <Icon :name="character.isLiked ? 'heart-filled' : 'heart'" />
        </el-button>

        <el-dropdown
          @click.stop
          placement="bottom-end"
        >
          <el-button circle size="small">
            <Icon name="more-vertical" />
          </el-button>
          <template #dropdown>
            <el-dropdown-menu>
              <el-dropdown-item @click="handleStartChat">
                <Icon name="message" /> 开始对话
              </el-dropdown-item>
              <el-dropdown-item @click="handleViewProfile">
                <Icon name="user" /> 查看详情
              </el-dropdown-item>
              <el-dropdown-item @click="handleShare">
                <Icon name="share" /> 分享角色
              </el-dropdown-item>
            </el-dropdown-menu>
          </template>
        </el-dropdown>
      </div>
    </div>

    <!-- 角色信息区域 -->
    <div class="character-info">
      <div class="character-header">
        <h3 class="character-name">{{ character.name }}</h3>
        <div v-if="showStats" class="character-stats">
          <span class="stat-item">
            <Icon name="message-circle" />
            {{ formatNumber(character.chatCount) }}
          </span>
          <span class="stat-item">
            <Icon name="heart" />
            {{ formatNumber(character.likeCount) }}
          </span>
        </div>
      </div>

      <p class="character-description">
        {{ truncateText(character.description, maxDescriptionLength) }}
      </p>

      <!-- 角色标签 -->
      <div v-if="character.tags?.length" class="character-tags">
        <el-tag
          v-for="tag in character.tags.slice(0, maxTags)"
          :key="tag.id"
          size="small"
          effect="plain"
          class="character-tag"
        >
          {{ tag.name }}
        </el-tag>
        <el-tag
          v-if="character.tags.length > maxTags"
          size="small"
          effect="plain"
          class="character-tag-more"
        >
          +{{ character.tags.length - maxTags }}
        </el-tag>
      </div>

      <!-- 创作者信息 -->
      <div class="character-creator" v-if="showCreator">
        <img
          :src="character.creator.avatar"
          :alt="character.creator.name"
          class="creator-avatar"
        />
        <span class="creator-name">{{ character.creator.name }}</span>
      </div>
    </div>

    <!-- 加载状态 -->
    <div v-if="loading" class="character-loading">
      <el-skeleton :rows="3" animated />
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, ref } from 'vue';
import { useRouter } from 'vue-router';
import { ElMessage } from 'element-plus';
import Icon from '@/components/ui/Icon.vue';
import { useCharacterActions } from '@/composables/useCharacterActions';
import { formatNumber, truncateText } from '@/utils/format';

interface Props {
  character: Character;
  size?: 'small' | 'medium' | 'large';
  interactive?: boolean;
  showActions?: boolean;
  showStats?: boolean;
  showCreator?: boolean;
  showOnlineStatus?: boolean;
  maxDescriptionLength?: number;
  maxTags?: number;
}

const props = withDefaults(defineProps<Props>(), {
  size: 'medium',
  interactive: true,
  showActions: true,
  showStats: true,
  showCreator: true,
  showOnlineStatus: false,
  maxDescriptionLength: 120,
  maxTags: 3
});

const emit = defineEmits<{
  click: [character: Character];
  like: [character: Character];
  chat: [character: Character];
}>();

const router = useRouter();
const { toggleLike, startChat } = useCharacterActions();

const loading = ref(false);
const defaultAvatar = '/images/default-avatar.png';

const handleCardClick = () => {
  if (props.interactive) {
    emit('click', props.character);
  }
};

const handleToggleLike = async () => {
  try {
    await toggleLike(props.character.id);
    emit('like', props.character);
  } catch (error) {
    ElMessage.error('操作失败，请稍后重试');
  }
};

const handleStartChat = () => {
  startChat(props.character.id);
  emit('chat', props.character);
};

const handleViewProfile = () => {
  router.push(`/character/${props.character.id}`);
};

const handleShare = async () => {
  try {
    await navigator.share({
      title: props.character.name,
      text: props.character.description,
      url: `${window.location.origin}/character/${props.character.id}`
    });
  } catch (error) {
    // 降级到复制链接
    navigator.clipboard.writeText(
      `${window.location.origin}/character/${props.character.id}`
    );
    ElMessage.success('链接已复制到剪贴板');
  }
};

const handleImageLoad = () => {
  loading.value = false;
};

const handleImageError = (event: Event) => {
  const target = event.target as HTMLImageElement;
  target.src = defaultAvatar;
};
</script>

<style lang="scss" scoped>
.character-card {
  position: relative;
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border);
  transition: all 0.3s ease;
  overflow: hidden;

  &--interactive {
    cursor: pointer;

    &:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--color-primary-300);

      .character-actions {
        opacity: 1;
        transform: translateY(0);
      }
    }
  }

  &--small {
    .character-avatar {
      width: 80px;
      height: 80px;
    }

    .character-name {
      font-size: 1rem;
    }
  }

  &--medium {
    .character-avatar {
      width: 120px;
      height: 120px;
    }

    .character-name {
      font-size: 1.25rem;
    }
  }

  &--large {
    .character-avatar {
      width: 160px;
      height: 160px;
    }

    .character-name {
      font-size: 1.5rem;
    }
  }
}

.character-avatar-section {
  position: relative;
  padding: var(--spacing-6);
  text-align: center;
}

.character-avatar-container {
  position: relative;
  display: inline-block;
}

.character-avatar {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--color-border);
  transition: all 0.3s ease;
}

.online-indicator {
  position: absolute;
  bottom: 8px;
  right: 8px;
  width: 16px;
  height: 16px;
  background: var(--color-success);
  border: 2px solid var(--color-surface);
  border-radius: 50%;
}

.character-actions {
  position: absolute;
  top: var(--spacing-4);
  right: var(--spacing-4);
  display: flex;
  gap: var(--spacing-2);
  opacity: 0;
  transform: translateY(-8px);
  transition: all 0.3s ease;
}

.character-info {
  padding: 0 var(--spacing-6) var(--spacing-6);
}

.character-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-3);
}

.character-name {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--color-text-primary);
  margin: 0;
  line-height: 1.3;
}

.character-stats {
  display: flex;
  gap: var(--spacing-3);
  font-size: 0.875rem;
  color: var(--color-text-secondary);

  .stat-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-1);
  }
}

.character-description {
  color: var(--color-text-secondary);
  line-height: 1.5;
  margin: 0 0 var(--spacing-4);
  font-size: 0.875rem;
}

.character-tags {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-2);
  margin-bottom: var(--spacing-4);
}

.character-tag,
.character-tag-more {
  font-size: 0.75rem;
}

.character-creator {
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
  padding-top: var(--spacing-4);
  border-top: 1px solid var(--color-border);
}

.creator-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  object-fit: cover;
}

.creator-name {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  font-weight: 500;
}

.character-loading {
  padding: var(--spacing-6);
}
</style>
```

### 2. 瀑布流布局组件
```vue
<template>
  <div ref="containerRef" class="masonry-container">
    <div
      class="masonry-grid"
      :style="{
        columnCount: columnCount,
        columnGap: `${gap}px`
      }"
    >
      <div
        v-for="(item, index) in visibleItems"
        :key="getItemKey(item, index)"
        class="masonry-item"
        :style="{ breakInside: 'avoid', marginBottom: `${gap}px` }"
      >
        <slot :item="item" :index="index" />
      </div>
    </div>

    <!-- 加载更多指示器 -->
    <div v-if="loading" class="masonry-loading">
      <el-skeleton
        v-for="n in skeletonCount"
        :key="n"
        :rows="3"
        animated
        class="skeleton-item"
      />
    </div>

    <!-- 滚动触发器 -->
    <div
      ref="loadTriggerRef"
      class="load-trigger"
      v-if="hasMore"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted, nextTick, watch } from 'vue';
import { useElementSize, useIntersectionObserver } from '@vueuse/core';

interface Props {
  items: any[];
  gap?: number;
  minColumnWidth?: number;
  hasMore?: boolean;
  loading?: boolean;
  getItemKey?: (item: any, index: number) => string | number;
}

const props = withDefaults(defineProps<Props>(), {
  gap: 16,
  minColumnWidth: 280,
  hasMore: false,
  loading: false,
  getItemKey: (item, index) => item.id || index
});

const emit = defineEmits<{
  loadMore: [];
}>();

const containerRef = ref<HTMLElement>();
const loadTriggerRef = ref<HTMLElement>();

const { width: containerWidth } = useElementSize(containerRef);

const columnCount = computed(() => {
  if (!containerWidth.value) return 1;
  return Math.floor(containerWidth.value / props.minColumnWidth) || 1;
});

const visibleItems = ref(props.items);
const skeletonCount = computed(() => Math.min(columnCount.value * 2, 8));

// 交集观察器，用于触发加载更多
const { stop: stopObserver } = useIntersectionObserver(
  loadTriggerRef,
  ([{ isIntersecting }]) => {
    if (isIntersecting && props.hasMore && !props.loading) {
      emit('loadMore');
    }
  },
  {
    rootMargin: '100px'
  }
);

// 监听items变化，更新可见项目
watch(
  () => props.items,
  (newItems) => {
    visibleItems.value = newItems;
  },
  { deep: true }
);

onUnmounted(() => {
  stopObserver();
});
</script>

<style lang="scss" scoped>
.masonry-container {
  width: 100%;
  position: relative;
}

.masonry-grid {
  column-fill: balance;
  column-gap: 16px;
}

.masonry-item {
  break-inside: avoid;
  page-break-inside: avoid;
}

.masonry-loading {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
  margin-top: 32px;

  .skeleton-item {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: var(--spacing-6);
  }
}

.load-trigger {
  height: 1px;
  width: 100%;
  position: absolute;
  bottom: 200px;
}

@media (max-width: 768px) {
  .masonry-grid {
    column-count: 1 !important;
  }

  .masonry-loading {
    grid-template-columns: 1fr;
  }
}

@media (min-width: 769px) and (max-width: 1024px) {
  .masonry-grid {
    column-count: 2 !important;
  }
}
</style>
```

### 3. @语法支持组件
```vue
<template>
  <div class="mention-input-container">
    <div
      ref="editorRef"
      class="mention-editor"
      :class="{ focused: isFocused }"
      contenteditable
      @input="handleInput"
      @focus="handleFocus"
      @blur="handleBlur"
      @keydown="handleKeyDown"
      v-html="displayText"
    />

    <!-- 自动补全下拉框 -->
    <div
      v-if="showSuggestions"
      class="suggestions-dropdown"
      :style="suggestionStyle"
    >
      <div
        v-for="(suggestion, index) in filteredSuggestions"
        :key="suggestion.id"
        :class="['suggestion-item', { active: index === selectedIndex }]"
        @click="selectSuggestion(suggestion)"
        @mouseenter="selectedIndex = index"
      >
        <img
          :src="suggestion.avatar"
          :alt="suggestion.name"
          class="suggestion-avatar"
        />
        <div class="suggestion-info">
          <div class="suggestion-name">{{ suggestion.name }}</div>
          <div class="suggestion-description">
            {{ suggestion.description }}
          </div>
        </div>
      </div>

      <div v-if="filteredSuggestions.length === 0" class="no-suggestions">
        未找到匹配的角色
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, nextTick, watch } from 'vue';
import { useCharacterSearch } from '@/composables/useCharacterSearch';
import { debounce } from 'lodash-es';

interface Props {
  modelValue: string;
  placeholder?: string;
  characters?: Character[];
}

const props = withDefaults(defineProps<Props>(), {
  placeholder: '输入消息... 使用 @ 提及角色',
  characters: () => []
});

const emit = defineEmits<{
  'update:modelValue': [value: string];
  mention: [character: Character];
}>();

const editorRef = ref<HTMLElement>();
const isFocused = ref(false);
const showSuggestions = ref(false);
const selectedIndex = ref(0);
const currentMention = ref('');
const mentionStart = ref(0);

const { searchCharacters, searchResults, isSearching } = useCharacterSearch();

const filteredSuggestions = computed(() => {
  if (!currentMention.value) return [];
  return searchResults.value.slice(0, 10);
});

const suggestionStyle = ref({});

const displayText = computed(() => {
  let text = props.modelValue;

  // 将@mentions转换为高亮显示
  text = text.replace(
    /@(\w+)/g,
    '<span class="mention-highlight">@$1</span>'
  );

  return text;
});

const handleInput = debounce(async (event: Event) => {
  const target = event.target as HTMLElement;
  const text = target.innerText || '';

  emit('update:modelValue', text);

  // 检测@符号
  const cursorPos = getCaretPosition();
  const beforeCursor = text.slice(0, cursorPos);
  const mentionMatch = beforeCursor.match(/@(\w*)$/);

  if (mentionMatch) {
    currentMention.value = mentionMatch[1];
    mentionStart.value = mentionMatch.index!;

    if (currentMention.value.length >= 1) {
      await searchCharacters(currentMention.value);
      showSuggestions.value = true;
      selectedIndex.value = 0;

      // 计算下拉框位置
      await nextTick();
      updateSuggestionPosition();
    }
  } else {
    hideSuggestions();
  }
}, 200);

const handleFocus = () => {
  isFocused.value = true;
};

const handleBlur = () => {
  isFocused.value = false;
  // 延迟隐藏，允许点击选择
  setTimeout(() => {
    hideSuggestions();
  }, 200);
};

const handleKeyDown = (event: KeyboardEvent) => {
  if (!showSuggestions.value) return;

  switch (event.key) {
    case 'ArrowDown':
      event.preventDefault();
      selectedIndex.value = Math.min(
        selectedIndex.value + 1,
        filteredSuggestions.value.length - 1
      );
      break;

    case 'ArrowUp':
      event.preventDefault();
      selectedIndex.value = Math.max(selectedIndex.value - 1, 0);
      break;

    case 'Enter':
    case 'Tab':
      event.preventDefault();
      if (filteredSuggestions.value[selectedIndex.value]) {
        selectSuggestion(filteredSuggestions.value[selectedIndex.value]);
      }
      break;

    case 'Escape':
      hideSuggestions();
      break;
  }
};

const selectSuggestion = (character: Character) => {
  const currentValue = props.modelValue;
  const beforeMention = currentValue.slice(0, mentionStart.value);
  const afterCursor = currentValue.slice(getCaretPosition());

  const newValue = beforeMention + `@${character.name} ` + afterCursor;

  emit('update:modelValue', newValue);
  emit('mention', character);

  hideSuggestions();

  // 设置光标位置
  nextTick(() => {
    const newPos = beforeMention.length + character.name.length + 2;
    setCaretPosition(newPos);
  });
};

const hideSuggestions = () => {
  showSuggestions.value = false;
  currentMention.value = '';
  selectedIndex.value = 0;
};

const getCaretPosition = (): number => {
  const selection = window.getSelection();
  if (!selection?.rangeCount) return 0;

  const range = selection.getRangeAt(0);
  const preCaretRange = range.cloneRange();
  preCaretRange.selectNodeContents(editorRef.value!);
  preCaretRange.setEnd(range.endContainer, range.endOffset);

  return preCaretRange.toString().length;
};

const setCaretPosition = (pos: number) => {
  const selection = window.getSelection();
  const range = document.createRange();

  let currentPos = 0;
  const walker = document.createTreeWalker(
    editorRef.value!,
    NodeFilter.SHOW_TEXT,
    null
  );

  let node;
  while ((node = walker.nextNode())) {
    const nodeLength = node.textContent!.length;
    if (currentPos + nodeLength >= pos) {
      range.setStart(node, pos - currentPos);
      range.collapse(true);
      selection?.removeAllRanges();
      selection?.addRange(range);
      break;
    }
    currentPos += nodeLength;
  }
};

const updateSuggestionPosition = () => {
  if (!editorRef.value) return;

  const rect = editorRef.value.getBoundingClientRect();
  const selection = window.getSelection();

  if (selection?.rangeCount) {
    const range = selection.getRangeAt(0);
    const rangeRect = range.getBoundingClientRect();

    suggestionStyle.value = {
      position: 'absolute',
      top: `${rangeRect.bottom + 8}px`,
      left: `${rangeRect.left}px`,
      zIndex: 1000
    };
  }
};

// 监听外部字符数据变化
watch(
  () => props.characters,
  (newCharacters) => {
    if (newCharacters.length > 0 && currentMention.value) {
      // 重新过滤建议
    }
  }
);
</script>

<style lang="scss" scoped>
.mention-input-container {
  position: relative;
  width: 100%;
}

.mention-editor {
  min-height: 100px;
  padding: var(--spacing-4);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  background: var(--color-background);
  color: var(--color-text-primary);
  font-family: inherit;
  font-size: 1rem;
  line-height: 1.5;
  transition: all 0.2s ease;
  outline: none;
  overflow-y: auto;

  &:hover {
    border-color: var(--color-primary-300);
  }

  &.focused,
  &:focus {
    border-color: var(--color-primary-500);
    box-shadow: 0 0 0 3px var(--color-primary-100);
  }

  &:empty::before {
    content: attr(placeholder);
    color: var(--color-text-placeholder);
    pointer-events: none;
  }

  :deep(.mention-highlight) {
    color: var(--color-primary-600);
    background: var(--color-primary-50);
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 500;
  }
}

.suggestions-dropdown {
  position: fixed;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  max-height: 300px;
  overflow-y: auto;
  min-width: 280px;
  z-index: 1000;
}

.suggestion-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-3);
  padding: var(--spacing-3);
  cursor: pointer;
  transition: background-color 0.2s ease;

  &:hover,
  &.active {
    background: var(--color-primary-50);
  }
}

.suggestion-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.suggestion-info {
  flex: 1;
  min-width: 0;
}

.suggestion-name {
  font-weight: 500;
  color: var(--color-text-primary);
  margin-bottom: 2px;
}

.suggestion-description {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.no-suggestions {
  padding: var(--spacing-4);
  text-align: center;
  color: var(--color-text-secondary);
  font-size: 0.875rem;
}
</style>
```

### 4. 优化角色创建器
```vue
<template>
  <div class="character-creator">
    <el-steps
      :active="currentStep"
      finish-status="success"
      class="creator-steps"
    >
      <el-step
        v-for="step in steps"
        :key="step.key"
        :title="step.title"
        :description="step.description"
      />
    </el-steps>

    <div class="creator-content">
      <!-- 步骤1：基本信息 -->
      <div v-show="currentStep === 0" class="step-content">
        <div class="step-header">
          <h3>角色基本信息</h3>
          <p>创建您的AI角色，设置基本属性和外观</p>
        </div>

        <div class="form-grid">
          <div class="form-section">
            <!-- 头像上传区域 -->
            <div class="avatar-upload-section">
              <div class="avatar-upload" @click="handleAvatarUpload">
                <img
                  v-if="formData.avatar"
                  :src="formData.avatar"
                  alt="角色头像"
                  class="avatar-preview"
                />
                <div v-else class="avatar-placeholder">
                  <Icon name="plus" size="24" />
                  <span>上传头像</span>
                </div>
              </div>

              <div class="avatar-actions">
                <el-button size="small" @click="generateAvatar">
                  AI生成头像
                </el-button>
                <el-button size="small" @click="selectFromGallery">
                  从图库选择
                </el-button>
              </div>
            </div>
          </div>

          <div class="form-section">
            <!-- 基本信息表单 -->
            <el-form
              :model="formData"
              :rules="basicInfoRules"
              ref="basicFormRef"
              label-position="top"
            >
              <el-form-item label="角色名称" prop="name">
                <el-input
                  v-model="formData.name"
                  placeholder="为您的角色起一个独特的名字"
                  maxlength="50"
                  show-word-limit
                />
              </el-form-item>

              <el-form-item label="角色简介" prop="description">
                <el-input
                  v-model="formData.description"
                  type="textarea"
                  :rows="4"
                  placeholder="简要描述您的角色..."
                  maxlength="200"
                  show-word-limit
                />
              </el-form-item>

              <el-form-item label="角色标签">
                <el-select
                  v-model="formData.tags"
                  multiple
                  filterable
                  allow-create
                  placeholder="添加标签，回车创建新标签"
                  class="full-width"
                >
                  <el-option
                    v-for="tag in popularTags"
                    :key="tag.id"
                    :label="tag.name"
                    :value="tag.name"
                  />
                </el-select>
              </el-form-item>

              <el-form-item label="可见性">
                <el-radio-group v-model="formData.visibility">
                  <el-radio value="public">公开 - 所有人可见</el-radio>
                  <el-radio value="private">私密 - 仅自己可见</el-radio>
                  <el-radio value="unlisted">不公开 - 仅通过链接访问</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-form>
          </div>
        </div>
      </div>

      <!-- 步骤2：角色设定 -->
      <div v-show="currentStep === 1" class="step-content">
        <div class="step-header">
          <h3>角色个性设定</h3>
          <p>详细描述角色的性格、背景和行为模式</p>
        </div>

        <el-form
          :model="formData"
          :rules="personalityRules"
          ref="personalityFormRef"
          label-position="top"
        >
          <el-form-item label="详细描述" prop="detailedDescription">
            <el-input
              v-model="formData.detailedDescription"
              type="textarea"
              :rows="6"
              placeholder="详细描述角色的外貌、性格、背景故事等..."
              maxlength="1000"
              show-word-limit
            />
            <div class="form-help">
              提示：详细的描述有助于AI更好地理解和扮演您的角色
            </div>
          </el-form-item>

          <el-form-item label="性格特点">
            <el-input
              v-model="formData.personality"
              type="textarea"
              :rows="4"
              placeholder="描述角色的性格特点，如开朗、内向、幽默等..."
              maxlength="500"
              show-word-limit
            />
          </el-form-item>

          <el-form-item label="说话方式">
            <el-input
              v-model="formData.speakingStyle"
              type="textarea"
              :rows="3"
              placeholder="角色的说话习惯、口头禅、语调等..."
              maxlength="300"
              show-word-limit
            />
          </el-form-item>

          <el-form-item label="示例对话">
            <div class="example-conversations">
              <div
                v-for="(example, index) in formData.exampleConversations"
                :key="index"
                class="conversation-pair"
              >
                <el-input
                  v-model="example.user"
                  placeholder="用户说..."
                  class="conversation-input"
                >
                  <template #prepend>用户</template>
                </el-input>
                <el-input
                  v-model="example.character"
                  placeholder="角色回应..."
                  class="conversation-input"
                >
                  <template #prepend>{{ formData.name || '角色' }}</template>
                </el-input>
                <el-button
                  type="danger"
                  text
                  @click="removeExample(index)"
                  :disabled="formData.exampleConversations.length <= 1"
                >
                  <Icon name="trash" />
                </el-button>
              </div>

              <el-button
                type="primary"
                text
                @click="addExample"
                :disabled="formData.exampleConversations.length >= 10"
              >
                <Icon name="plus" /> 添加示例对话
              </el-button>
            </div>
          </el-form-item>
        </el-form>
      </div>

      <!-- 步骤3：预览确认 -->
      <div v-show="currentStep === 2" class="step-content">
        <div class="step-header">
          <h3>预览和确认</h3>
          <p>检查您的角色设定，确认后即可创建</p>
        </div>

        <div class="preview-section">
          <div class="character-preview-card">
            <CharacterCard
              :character="previewCharacter"
              :size="'large'"
              :interactive="false"
              :show-actions="false"
            />
          </div>

          <div class="test-conversation">
            <h4>测试对话</h4>
            <div class="test-chat">
              <div class="test-message user-message">
                <span>你好，很高兴认识你！</span>
              </div>
              <div class="test-message character-message">
                <img
                  :src="formData.avatar"
                  :alt="formData.name"
                  class="message-avatar"
                />
                <span>{{ generateTestResponse() }}</span>
              </div>
            </div>

            <el-button @click="regenerateTestResponse">
              重新生成回应
            </el-button>
          </div>
        </div>
      </div>
    </div>

    <!-- 底部操作按钮 -->
    <div class="creator-footer">
      <el-button
        v-if="currentStep > 0"
        @click="previousStep"
      >
        上一步
      </el-button>

      <div class="footer-actions">
        <el-button @click="saveDraft">
          保存草稿
        </el-button>

        <el-button
          v-if="currentStep < steps.length - 1"
          type="primary"
          @click="nextStep"
          :loading="validating"
        >
          下一步
        </el-button>

        <el-button
          v-else
          type="primary"
          @click="createCharacter"
          :loading="creating"
        >
          创建角色
        </el-button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, computed, onMounted } from 'vue';
import { ElMessage, ElMessageBox } from 'element-plus';
import { useRouter } from 'vue-router';
import CharacterCard from '@/components/character/CharacterCard.vue';
import Icon from '@/components/ui/Icon.vue';
import { characterApi } from '@/api/character';
import { aiService } from '@/api/ai';

const router = useRouter();

const currentStep = ref(0);
const validating = ref(false);
const creating = ref(false);

const steps = [
  { key: 'basic', title: '基本信息', description: '角色基本属性' },
  { key: 'personality', title: '角色设定', description: '性格和行为' },
  { key: 'preview', title: '预览确认', description: '检查和测试' }
];

const formData = reactive({
  name: '',
  description: '',
  detailedDescription: '',
  personality: '',
  speakingStyle: '',
  avatar: '',
  tags: [],
  visibility: 'public',
  exampleConversations: [
    { user: '', character: '' }
  ]
});

const basicFormRef = ref();
const personalityFormRef = ref();

const basicInfoRules = {
  name: [
    { required: true, message: '请输入角色名称', trigger: 'blur' },
    { min: 1, max: 50, message: '名称长度应在1-50个字符', trigger: 'blur' }
  ],
  description: [
    { required: true, message: '请输入角色简介', trigger: 'blur' },
    { min: 10, max: 200, message: '简介长度应在10-200个字符', trigger: 'blur' }
  ]
};

const personalityRules = {
  detailedDescription: [
    { required: true, message: '请输入详细描述', trigger: 'blur' },
    { min: 50, max: 1000, message: '描述长度应在50-1000个字符', trigger: 'blur' }
  ]
};

const popularTags = ref([]);

const previewCharacter = computed(() => ({
  id: 'preview',
  name: formData.name || '新角色',
  description: formData.description,
  avatar: formData.avatar,
  tags: formData.tags.map(tag => ({ id: tag, name: tag })),
  creator: { name: '您', avatar: '/default-user-avatar.png' },
  chatCount: 0,
  likeCount: 0,
  isLiked: false
}));

const nextStep = async () => {
  if (currentStep.value === 0) {
    // 验证基本信息
    if (!await validateBasicInfo()) return;
  } else if (currentStep.value === 1) {
    // 验证角色设定
    if (!await validatePersonality()) return;
  }

  currentStep.value = Math.min(currentStep.value + 1, steps.length - 1);
};

const previousStep = () => {
  currentStep.value = Math.max(currentStep.value - 1, 0);
};

const validateBasicInfo = async () => {
  if (!basicFormRef.value) return false;

  try {
    validating.value = true;
    await basicFormRef.value.validate();
    return true;
  } catch (error) {
    return false;
  } finally {
    validating.value = false;
  }
};

const validatePersonality = async () => {
  if (!personalityFormRef.value) return false;

  try {
    validating.value = true;
    await personalityFormRef.value.validate();
    return true;
  } catch (error) {
    return false;
  } finally {
    validating.value = false;
  }
};

const addExample = () => {
  formData.exampleConversations.push({ user: '', character: '' });
};

const removeExample = (index: number) => {
  formData.exampleConversations.splice(index, 1);
};

const generateAvatar = async () => {
  try {
    ElMessage.info('正在生成头像，请稍候...');
    const response = await aiService.generateAvatar({
      description: formData.detailedDescription || formData.description,
      style: 'anime'
    });
    formData.avatar = response.data.url;
    ElMessage.success('头像生成成功！');
  } catch (error) {
    ElMessage.error('头像生成失败，请稍后重试');
  }
};

const generateTestResponse = () => {
  if (!formData.personality || !formData.speakingStyle) {
    return '你好！很高兴见到你！';
  }

  // 基于角色设定生成简单的测试回应
  const greetings = ['你好', '嗨', '哈喽'];
  const personalities = formData.personality.split('、');
  const styles = formData.speakingStyle.split('、');

  return `${greetings[Math.floor(Math.random() * greetings.length)]}！我是${formData.name}，${personalities[0] || '很高兴认识你'}！`;
};

const regenerateTestResponse = () => {
  // 强制重新渲染测试回应
  // 这里可以调用AI服务生成更智能的回应
};

const saveDraft = async () => {
  try {
    await characterApi.saveDraft(formData);
    ElMessage.success('草稿已保存');
  } catch (error) {
    ElMessage.error('保存草稿失败');
  }
};

const createCharacter = async () => {
  try {
    creating.value = true;

    const characterData = {
      ...formData,
      exampleConversations: formData.exampleConversations.filter(
        conv => conv.user.trim() && conv.character.trim()
      )
    };

    const response = await characterApi.create(characterData);

    ElMessage.success('角色创建成功！');
    router.push(`/character/${response.data.id}`);
  } catch (error) {
    ElMessage.error('创建失败，请稍后重试');
  } finally {
    creating.value = false;
  }
};

const handleAvatarUpload = () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        formData.avatar = e.target?.result as string;
      };
      reader.readAsDataURL(file);
    }
  };
  input.click();
};

onMounted(async () => {
  // 加载热门标签
  try {
    const response = await characterApi.getPopularTags();
    popularTags.value = response.data;
  } catch (error) {
    console.error('加载标签失败:', error);
  }
});
</script>

<style lang="scss" scoped>
.character-creator {
  max-width: 1000px;
  margin: 0 auto;
  padding: var(--spacing-6);
}

.creator-steps {
  margin-bottom: var(--spacing-8);
}

.step-content {
  min-height: 500px;
  animation: fadeIn 0.3s ease;
}

.step-header {
  text-align: center;
  margin-bottom: var(--spacing-8);

  h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: var(--spacing-2);
    color: var(--color-text-primary);
  }

  p {
    color: var(--color-text-secondary);
  }
}

.form-grid {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: var(--spacing-8);

  @media (max-width: 768px) {
    grid-template-columns: 1fr;
  }
}

.avatar-upload-section {
  text-align: center;
}

.avatar-upload {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  border: 2px dashed var(--color-border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin: 0 auto var(--spacing-4);
  transition: all 0.3s ease;

  &:hover {
    border-color: var(--color-primary-500);
    background: var(--color-primary-50);
  }
}

.avatar-preview {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
}

.avatar-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-2);
  color: var(--color-text-secondary);

  span {
    font-size: 0.875rem;
  }
}

.avatar-actions {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-2);
}

.full-width {
  width: 100%;
}

.form-help {
  font-size: 0.75rem;
  color: var(--color-text-secondary);
  margin-top: var(--spacing-2);
}

.example-conversations {
  .conversation-pair {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: var(--spacing-3);
    align-items: center;
    margin-bottom: var(--spacing-3);
  }

  .conversation-input {
    margin-bottom: 0;
  }
}

.preview-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-8);

  @media (max-width: 768px) {
    grid-template-columns: 1fr;
  }
}

.character-preview-card {
  background: var(--color-background);
  padding: var(--spacing-6);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border);
}

.test-conversation {
  h4 {
    margin-bottom: var(--spacing-4);
    color: var(--color-text-primary);
  }
}

.test-chat {
  background: var(--color-surface);
  border-radius: var(--radius-md);
  padding: var(--spacing-4);
  margin-bottom: var(--spacing-4);
  min-height: 120px;
}

.test-message {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-3);
  margin-bottom: var(--spacing-3);

  &.user-message {
    justify-content: flex-end;

    span {
      background: var(--color-primary-500);
      color: white;
      padding: var(--spacing-2) var(--spacing-3);
      border-radius: var(--radius-md);
      max-width: 70%;
    }
  }

  &.character-message {
    span {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      padding: var(--spacing-2) var(--spacing-3);
      border-radius: var(--radius-md);
      max-width: 70%;
    }
  }
}

.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  flex-shrink: 0;
}

.creator-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: var(--spacing-8);
  padding-top: var(--spacing-6);
  border-top: 1px solid var(--color-border);
}

.footer-actions {
  display: flex;
  gap: var(--spacing-3);
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
```

## 验收标准

### 功能验收
- [ ] 角色卡片支持多种尺寸，响应式布局完美
- [ ] 瀑布流布局流畅，支持无限滚动和虚拟化
- [ ] @语法自动补全准确，支持键盘导航
- [ ] 角色创建器分步流程完整，支持草稿保存
- [ ] AI辅助功能正常工作（头像生成、文案建议）

### 性能验收
- [ ] 大量角色卡片渲染流畅，无卡顿现象
- [ ] 瀑布流滚动性能良好，内存占用合理
- [ ] @语法搜索响应快速，支持防抖优化
- [ ] 图片懒加载有效，减少初始加载时间
- [ ] 创建器表单验证实时，体验流畅

### 视觉验收
- [ ] 卡片设计现代美观，符合新设计系统
- [ ] 悬停动画自然，增强交互体验
- [ ] 瀑布流布局整齐，间距协调
- [ ] @语法高亮清晰，补全框设计优雅
- [ ] 创建器界面友好，引导清晰

## 影响范围

### 直接影响
- `apps/web/src/components/character/` - 角色相关组件
- `apps/web/src/views/character/` - 角色相关页面
- `apps/web/src/components/ui/` - 通用UI组件

### 相关文件
- `apps/web/src/api/character.ts` - 角色API
- `apps/web/src/composables/useCharacter*.ts` - 角色相关组合式函数
- `apps/web/src/utils/format.ts` - 格式化工具函数

## 风险评估

### 技术风险
- **高**: 瀑布流性能优化复杂度高
- **中等**: @语法实现涉及复杂的文本处理
- **中等**: 大量动画可能影响低端设备性能

### 缓解措施
- 使用虚拟化技术优化瀑布流性能
- 分步实现@语法，先实现核心功能
- 提供性能降级选项，动画可配置

## 后续任务

- TASK-XINXUQIU-004: 聊天系统UI升级适配新角色卡片
- TASK-XINXUQIU-005: 角色搜索和推荐算法优化
- TASK-XINXUQIU-006: 移动端角色系统体验优化

---

*该任务将彻底升级角色系统的用户体验，打造业界领先的AI角色管理平台。*
