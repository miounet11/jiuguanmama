# Task 006: 角色创建页面重构

## 任务信息
- **Epic**: frontend-design-system-overhaul
- **任务标题**: 步骤化创建流程 + 实时预览功能
- **任务编号**: 006
- **估算时间**: 2天
- **优先级**: 高
- **状态**: 待开始
- **分配**: 待分配
- **创建时间**: 2025-09-23T07:26:51Z
- **依赖任务**: [001, 002]
- **可并行执行**: true

## 任务描述

重构TavernAI Plus的角色创建页面，实现直观的步骤化创建流程，提供实时预览功能，优化表单设计和验证体验，让用户能够轻松创建高质量的AI角色。

## 详细需求

### 1. 步骤化创建流程
- **多步骤向导**：将复杂的创建过程分解为简单步骤
- **进度指示**：清晰的进度条和步骤指示器
- **流程导航**：支持前进、后退、跳转操作
- **状态保存**：自动保存用户输入，防止数据丢失

### 2. 实时预览功能
- **角色卡片预览**：实时显示角色卡片效果
- **头像预览**：头像上传和预览功能
- **设定预览**：角色设定的格式化预览
- **对话预览**：模拟对话效果预览

### 3. 表单优化设计
- **智能表单**：根据输入自动调整和建议
- **富文本编辑**：支持格式化的角色描述编辑
- **模板系统**：提供角色创建模板和示例
- **验证反馈**：实时验证和友好的错误提示

### 4. 高级创建功能
- **AI辅助创建**：AI生成角色设定和描述
- **批量导入**：支持从文件导入角色数据
- **标签系统**：角色分类和标签管理
- **权限设置**：角色可见性和分享权限

## 技术实现

### 文件结构
```
apps/web/src/views/characters/
├── CreateCharacter.vue       # 主创建页面
├── components/
│   ├── CreationWizard.vue    # 创建向导
│   ├── StepIndicator.vue     # 步骤指示器
│   ├── steps/
│   │   ├── BasicInfoStep.vue # 基本信息步骤
│   │   ├── AppearanceStep.vue# 外观设置步骤
│   │   ├── PersonalityStep.vue# 性格设定步骤
│   │   ├── BackstoryStep.vue # 背景故事步骤
│   │   └── ReviewStep.vue    # 最终确认步骤
│   ├── preview/
│   │   ├── CharacterPreview.vue # 角色预览
│   │   ├── CardPreview.vue   # 卡片预览
│   │   └── ChatPreview.vue   # 对话预览
│   └── forms/
│       ├── CharacterForm.vue # 角色表单
│       ├── AvatarUpload.vue  # 头像上传
│       └── RichTextEditor.vue# 富文本编辑器
├── composables/
│   ├── useCharacterCreation.ts # 创建逻辑
│   ├── useFormValidation.ts  # 表单验证
│   └── usePreview.ts         # 预览功能
└── styles/
    ├── creation.scss         # 创建页面样式
    ├── wizard.scss           # 向导样式
    └── preview.scss          # 预览样式
```

### 核心组件实现

#### CreationWizard组件
```vue
<template>
  <div class="creation-wizard">
    <div class="wizard-header">
      <h1 class="wizard-title">{{ $t('character.create.title') }}</h1>
      <StepIndicator
        :steps="wizardSteps"
        :current-step="currentStep"
        @step-click="goToStep"
      />
    </div>

    <div class="wizard-content">
      <div class="wizard-main">
        <Transition name="step-slide" mode="out-in">
          <component
            :is="currentStepComponent"
            :key="currentStep"
            v-model="characterData"
            :errors="validationErrors"
            @next="nextStep"
            @prev="prevStep"
            @validate="validateStep"
          />
        </Transition>

        <div class="wizard-navigation">
          <button
            class="btn-secondary"
            :disabled="currentStep === 0"
            @click="prevStep"
          >
            {{ $t('common.previous') }}
          </button>

          <button
            class="btn-primary"
            :disabled="!canProceed"
            @click="nextStep"
          >
            {{
              currentStep === wizardSteps.length - 1
                ? $t('character.create.finish')
                : $t('common.next')
            }}
          </button>
        </div>
      </div>

      <div class="wizard-preview">
        <CharacterPreview
          :character="characterData"
          :current-step="currentStep"
        />
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { useCharacterCreation } from '@/composables/useCharacterCreation'
import { useFormValidation } from '@/composables/useFormValidation'

import BasicInfoStep from './steps/BasicInfoStep.vue'
import AppearanceStep from './steps/AppearanceStep.vue'
import PersonalityStep from './steps/PersonalityStep.vue'
import BackstoryStep from './steps/BackstoryStep.vue'
import ReviewStep from './steps/ReviewStep.vue'

const wizardSteps = [
  { id: 'basic', title: '基本信息', component: BasicInfoStep },
  { id: 'appearance', title: '外观设定', component: AppearanceStep },
  { id: 'personality', title: '性格特征', component: PersonalityStep },
  { id: 'backstory', title: '背景故事', component: BackstoryStep },
  { id: 'review', title: '确认创建', component: ReviewStep }
]

const {
  characterData,
  currentStep,
  saveProgress,
  createCharacter
} = useCharacterCreation()

const {
  validationErrors,
  validateStep,
  canProceed
} = useFormValidation(characterData)

const currentStepComponent = computed(() => {
  return wizardSteps[currentStep.value]?.component
})

const nextStep = async () => {
  if (currentStep.value === wizardSteps.length - 1) {
    await createCharacter()
  } else {
    const isValid = await validateStep(currentStep.value)
    if (isValid) {
      currentStep.value++
      await saveProgress()
    }
  }
}

const prevStep = () => {
  if (currentStep.value > 0) {
    currentStep.value--
  }
}

const goToStep = (stepIndex: number) => {
  if (stepIndex <= currentStep.value) {
    currentStep.value = stepIndex
  }
}
</script>
```

#### CharacterPreview组件
```vue
<template>
  <div class="character-preview">
    <div class="preview-tabs">
      <button
        v-for="tab in previewTabs"
        :key="tab.id"
        class="tab-btn"
        :class="{ active: activeTab === tab.id }"
        @click="activeTab = tab.id"
      >
        {{ tab.title }}
      </button>
    </div>

    <div class="preview-content">
      <CardPreview
        v-if="activeTab === 'card'"
        :character="character"
      />

      <ChatPreview
        v-else-if="activeTab === 'chat'"
        :character="character"
      />

      <div v-else-if="activeTab === 'json'" class="json-preview">
        <pre><code>{{ JSON.stringify(character, null, 2) }}</code></pre>
      </div>
    </div>

    <div class="preview-actions">
      <button class="btn-outline" @click="exportCharacter">
        <Icon name="download" />
        {{ $t('character.export') }}
      </button>

      <button class="btn-outline" @click="testCharacter">
        <Icon name="play" />
        {{ $t('character.test') }}
      </button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { usePreview } from '@/composables/usePreview'
import type { Character } from '@/types/character'

interface Props {
  character: Partial<Character>
  currentStep: number
}

const props = defineProps<Props>()

const activeTab = ref('card')

const previewTabs = [
  { id: 'card', title: '角色卡片' },
  { id: 'chat', title: '对话预览' },
  { id: 'json', title: 'JSON数据' }
]

const { exportCharacter, testCharacter } = usePreview()
</script>
```

#### BasicInfoStep组件
```vue
<template>
  <div class="creation-step basic-info-step">
    <div class="step-header">
      <h2>{{ $t('character.create.steps.basicInfo.title') }}</h2>
      <p>{{ $t('character.create.steps.basicInfo.description') }}</p>
    </div>

    <div class="step-content">
      <div class="form-section">
        <div class="form-group">
          <label class="form-label required">
            {{ $t('character.fields.name') }}
          </label>
          <input
            v-model="localData.name"
            type="text"
            class="form-input"
            :class="{ error: errors.name }"
            :placeholder="$t('character.create.placeholders.name')"
            @blur="validateField('name')"
          />
          <div v-if="errors.name" class="form-error">
            {{ errors.name }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            {{ $t('character.fields.title') }}
          </label>
          <input
            v-model="localData.title"
            type="text"
            class="form-input"
            :placeholder="$t('character.create.placeholders.title')"
          />
        </div>

        <div class="form-group">
          <label class="form-label required">
            {{ $t('character.fields.description') }}
          </label>
          <RichTextEditor
            v-model="localData.description"
            :placeholder="$t('character.create.placeholders.description')"
            :error="errors.description"
            @blur="validateField('description')"
          />
          <div v-if="errors.description" class="form-error">
            {{ errors.description }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            {{ $t('character.fields.tags') }}
          </label>
          <TagInput
            v-model="localData.tags"
            :suggestions="tagSuggestions"
            :placeholder="$t('character.create.placeholders.tags')"
          />
        </div>
      </div>

      <div class="form-section">
        <div class="form-group">
          <label class="form-label">
            {{ $t('character.fields.avatar') }}
          </label>
          <AvatarUpload
            v-model="localData.avatar"
            :character-name="localData.name"
            @upload="handleAvatarUpload"
          />
        </div>

        <div class="form-group">
          <label class="form-label">
            {{ $t('character.fields.visibility') }}
          </label>
          <select v-model="localData.visibility" class="form-select">
            <option value="private">{{ $t('character.visibility.private') }}</option>
            <option value="unlisted">{{ $t('character.visibility.unlisted') }}</option>
            <option value="public">{{ $t('character.visibility.public') }}</option>
          </select>
        </div>
      </div>
    </div>

    <div class="step-tips">
      <div class="tip-card">
        <Icon name="lightbulb" />
        <div>
          <h4>{{ $t('character.create.tips.name.title') }}</h4>
          <p>{{ $t('character.create.tips.name.content') }}</p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { useTagSuggestions } from '@/composables/useTagSuggestions'
import type { Character } from '@/types/character'

interface Props {
  modelValue: Partial<Character>
  errors: Record<string, string>
}

const props = defineProps<Props>()
const emit = defineEmits<{
  'update:modelValue': [value: Partial<Character>]
  validate: [field: string]
}>()

const localData = computed({
  get: () => props.modelValue,
  set: (value) => emit('update:modelValue', value)
})

const { tagSuggestions } = useTagSuggestions()

const validateField = (field: string) => {
  emit('validate', field)
}

const handleAvatarUpload = (avatarUrl: string) => {
  localData.value.avatar = avatarUrl
}
</script>
```

### 样式系统

#### 创建向导样式
```scss
// wizard.scss
.creation-wizard {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background: var(--color-background);
}

.wizard-header {
  padding: 2rem;
  border-bottom: 1px solid var(--color-border);
  background: var(--color-card-background);

  .wizard-title {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--color-text-primary);
  }
}

.wizard-content {
  display: grid;
  grid-template-columns: 1fr 400px;
  flex: 1;
  overflow: hidden;

  @include respond-below('desktop') {
    grid-template-columns: 1fr;
  }
}

.wizard-main {
  display: flex;
  flex-direction: column;
  padding: 2rem;
  overflow-y: auto;
}

.wizard-preview {
  border-left: 1px solid var(--color-border);
  background: var(--color-card-background);
  overflow-y: auto;

  @include respond-below('desktop') {
    display: none;
  }
}

.wizard-navigation {
  display: flex;
  justify-content: space-between;
  gap: 1rem;
  margin-top: auto;
  padding-top: 2rem;
  border-top: 1px solid var(--color-border);
}

// 步骤过渡动画
.step-slide-enter-active,
.step-slide-leave-active {
  transition: all 0.3s ease;
}

.step-slide-enter-from {
  opacity: 0;
  transform: translateX(20px);
}

.step-slide-leave-to {
  opacity: 0;
  transform: translateX(-20px);
}
```

#### 表单样式
```scss
// creation.scss
.creation-step {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.step-header {
  margin-bottom: 2rem;

  h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--color-text-primary);
  }

  p {
    color: var(--color-text-secondary);
    font-size: 0.9rem;
  }
}

.step-content {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;

  @include respond-below('tablet') {
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }
}

.form-section {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-label {
  font-weight: 500;
  color: var(--color-text-primary);
  font-size: 0.9rem;

  &.required::after {
    content: ' *';
    color: var(--color-error);
  }
}

.form-input,
.form-select {
  padding: 0.75rem;
  border: 2px solid var(--color-border);
  border-radius: 8px;
  background: var(--color-input-background);
  color: var(--color-text);
  font-size: 0.9rem;
  transition: all 0.2s ease;

  &:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-alpha);
  }

  &.error {
    border-color: var(--color-error);
  }

  &::placeholder {
    color: var(--color-text-placeholder);
  }
}

.form-error {
  color: var(--color-error);
  font-size: 0.8rem;
  margin-top: 0.25rem;
}

.step-tips {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid var(--color-border);
}

.tip-card {
  display: flex;
  gap: 1rem;
  padding: 1rem;
  background: var(--color-info-background);
  border: 1px solid var(--color-info-border);
  border-radius: 8px;

  .icon {
    color: var(--color-info);
    flex-shrink: 0;
  }

  h4 {
    font-weight: 500;
    margin-bottom: 0.25rem;
    color: var(--color-info);
  }

  p {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    line-height: 1.4;
  }
}
```

#### 预览样式
```scss
// preview.scss
.character-preview {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.preview-tabs {
  display: flex;
  border-bottom: 1px solid var(--color-border);
}

.tab-btn {
  padding: 0.75rem 1rem;
  border: none;
  background: transparent;
  color: var(--color-text-secondary);
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s ease;
  border-bottom: 2px solid transparent;

  &:hover {
    color: var(--color-text-primary);
    background: var(--color-hover);
  }

  &.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    background: var(--color-primary-alpha);
  }
}

.preview-content {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
}

.preview-actions {
  padding: 1rem;
  border-top: 1px solid var(--color-border);
  display: flex;
  gap: 0.5rem;
}

.json-preview {
  pre {
    background: var(--color-code-background);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 1rem;
    overflow-x: auto;
    font-size: 0.8rem;
    line-height: 1.4;

    code {
      color: var(--color-code-text);
    }
  }
}
```

## Composable 实现

### useCharacterCreation.ts
```typescript
import { ref, reactive, watch } from 'vue'
import { useRouter } from 'vue-router'
import { characterApi } from '@/services/api'
import type { Character } from '@/types/character'

export function useCharacterCreation() {
  const router = useRouter()
  const currentStep = ref(0)
  const isCreating = ref(false)

  const characterData = reactive<Partial<Character>>({
    name: '',
    title: '',
    description: '',
    avatar: '',
    tags: [],
    visibility: 'private',
    personality: {
      traits: [],
      speakingStyle: '',
      behavior: ''
    },
    backstory: {
      background: '',
      motivation: '',
      relationships: []
    }
  })

  // 自动保存进度
  const saveProgress = async () => {
    try {
      localStorage.setItem('character-creation-progress', JSON.stringify({
        step: currentStep.value,
        data: characterData
      }))
    } catch (error) {
      console.error('保存进度失败:', error)
    }
  }

  // 恢复进度
  const restoreProgress = () => {
    try {
      const saved = localStorage.getItem('character-creation-progress')
      if (saved) {
        const { step, data } = JSON.parse(saved)
        currentStep.value = step
        Object.assign(characterData, data)
      }
    } catch (error) {
      console.error('恢复进度失败:', error)
    }
  }

  // 创建角色
  const createCharacter = async () => {
    isCreating.value = true

    try {
      const character = await characterApi.create(characterData as Character)

      // 清除保存的进度
      localStorage.removeItem('character-creation-progress')

      // 跳转到角色详情页
      router.push(`/characters/${character.id}`)

      return character
    } catch (error) {
      console.error('创建角色失败:', error)
      throw error
    } finally {
      isCreating.value = false
    }
  }

  // 监听数据变化，自动保存
  watch(characterData, saveProgress, { deep: true })

  return {
    characterData,
    currentStep,
    isCreating,
    saveProgress,
    restoreProgress,
    createCharacter
  }
}
```

## 验收标准

### 功能验收
- [ ] 步骤化向导流程正常工作
- [ ] 实时预览功能准确显示
- [ ] 表单验证和错误提示完整
- [ ] 自动保存和恢复功能正常

### 用户体验验收
- [ ] 创建流程直观易懂
- [ ] 表单填写体验流畅
- [ ] 预览功能实用有效
- [ ] 错误提示友好清晰

### 技术验收
- [ ] 组件结构清晰模块化
- [ ] 数据流管理规范
- [ ] 性能优化合理
- [ ] 代码质量符合标准

### 响应式验收
- [ ] 桌面端布局合理
- [ ] 平板端体验良好
- [ ] 移动端适配完整
- [ ] 各断点过渡平滑

## 文件清单

### 新增文件
- `apps/web/src/views/characters/components/CreationWizard.vue`
- `apps/web/src/views/characters/components/StepIndicator.vue`
- `apps/web/src/views/characters/components/steps/BasicInfoStep.vue`
- `apps/web/src/views/characters/components/steps/AppearanceStep.vue`
- `apps/web/src/views/characters/components/steps/PersonalityStep.vue`
- `apps/web/src/views/characters/components/steps/BackstoryStep.vue`
- `apps/web/src/views/characters/components/steps/ReviewStep.vue`
- `apps/web/src/views/characters/components/preview/CharacterPreview.vue`
- `apps/web/src/views/characters/components/preview/CardPreview.vue`
- `apps/web/src/views/characters/components/preview/ChatPreview.vue`
- `apps/web/src/views/characters/components/forms/AvatarUpload.vue`
- `apps/web/src/views/characters/components/forms/RichTextEditor.vue`
- `apps/web/src/composables/useCharacterCreation.ts`
- `apps/web/src/composables/useFormValidation.ts`
- `apps/web/src/composables/usePreview.ts`
- `apps/web/src/views/characters/styles/creation.scss`
- `apps/web/src/views/characters/styles/wizard.scss`
- `apps/web/src/views/characters/styles/preview.scss`

### 修改文件
- `apps/web/src/views/characters/CreateCharacter.vue` - 重构为向导模式
- `apps/web/src/router/index.ts` - 更新路由配置
- `apps/web/src/types/character.ts` - 扩展角色类型定义

## 注意事项

1. **数据验证**：确保每个步骤的数据验证完整
2. **用户体验**：保持创建流程的连贯性和直观性
3. **性能优化**：大文件上传和预览性能优化
4. **错误处理**：网络错误和数据错误的优雅处理
5. **可访问性**：键盘导航和屏幕阅读器支持
