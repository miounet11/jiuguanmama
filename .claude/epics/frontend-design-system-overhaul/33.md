# Task 005: 对话界面升级

## 任务信息
- **Epic**: frontend-design-system-overhaul
- **任务标题**: 沉浸式聊天体验 + 消息组件优化
- **任务编号**: 005
- **估算时间**: 2天
- **优先级**: 高
- **状态**: 待开始
- **分配**: 待分配
- **创建时间**: 2025-09-23T07:26:51Z
- **依赖任务**: [001, 002]
- **可并行执行**: true

## 任务描述

升级TavernAI Plus的对话界面，创建沉浸式的聊天体验，优化消息组件的视觉设计和交互体验，提供现代化、美观、易用的对话界面。

## 详细需求

### 1. 界面设计理念
- **沉浸式体验**：最小化干扰，专注对话内容
- **视觉层次**：清晰的信息层级和视觉引导
- **情感表达**：通过视觉设计传达角色个性
- **直观操作**：简化操作流程，提升用户体验

### 2. 消息组件优化
- **气泡设计**：美观的对话气泡和排版
- **角色标识**：清晰的角色头像和名称展示
- **消息状态**：发送状态、时间戳、已读状态
- **互动功能**：点赞、回复、复制等快捷操作

### 3. 输入体验优化
- **智能输入框**：自适应高度、快捷键支持
- **功能集成**：表情、文件、语音等功能整合
- **输入提示**：智能建议和自动完成
- **状态反馈**：正在输入、发送状态等

### 4. 沉浸式功能
- **全屏模式**：专注对话的全屏体验
- **主题氛围**：根据角色调整界面氛围
- **动画效果**：自然的动画和过渡效果
- **声音反馈**：可选的声音提示和反馈

## 技术实现

### 文件结构
```
apps/web/src/views/chat/
├── ChatSession.vue           # 主聊天页面
├── components/
│   ├── ChatContainer.vue     # 聊天容器
│   ├── MessageList.vue       # 消息列表
│   ├── MessageBubble.vue     # 消息气泡
│   ├── MessageInput.vue      # 输入组件
│   ├── ChatHeader.vue        # 聊天头部
│   ├── ChatSidebar.vue       # 侧边栏
│   └── MessageActions.vue    # 消息操作
├── composables/
│   ├── useChat.ts            # 聊天逻辑
│   ├── useMessageInput.ts    # 输入逻辑
│   └── useChatUI.ts          # UI状态管理
└── styles/
    ├── chat.scss             # 主要样式
    ├── message.scss          # 消息样式
    └── animations.scss       # 动画效果
```

### 核心组件实现

#### ChatContainer组件
```vue
<template>
  <div class="chat-container" :class="{ 'immersive-mode': isImmersive }">
    <ChatHeader
      :character="currentCharacter"
      :is-immersive="isImmersive"
      @toggle-immersive="toggleImmersiveMode"
      @open-settings="openSettings"
    />

    <MessageList
      ref="messageList"
      :messages="messages"
      :is-loading="isLoading"
      @message-action="handleMessageAction"
    />

    <MessageInput
      v-model="inputMessage"
      :is-sending="isSending"
      :placeholder="inputPlaceholder"
      @send="sendMessage"
      @typing="handleTyping"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useChat } from '@/composables/useChat'
import { useChatUI } from '@/composables/useChatUI'

const { messages, sendMessage, isLoading, isSending } = useChat()
const { isImmersive, toggleImmersiveMode } = useChatUI()

const inputMessage = ref('')
const messageList = ref()

const inputPlaceholder = computed(() => {
  return currentCharacter.value
    ? `与${currentCharacter.value.name}对话...`
    : '开始对话...'
})
</script>
```

#### MessageBubble组件
```vue
<template>
  <div
    class="message-bubble"
    :class="messageClasses"
    :data-message-id="message.id"
  >
    <div class="message-avatar" v-if="showAvatar">
      <img :src="message.avatar" :alt="message.senderName" />
      <div class="avatar-indicator" :class="{ 'online': isOnline }"></div>
    </div>

    <div class="message-content">
      <div class="message-header" v-if="showHeader">
        <span class="sender-name">{{ message.senderName }}</span>
        <span class="message-time">{{ formatTime(message.timestamp) }}</span>
      </div>

      <div class="message-body">
        <div class="message-text" v-html="formatMessage(message.content)"></div>
        <div class="message-attachments" v-if="message.attachments?.length">
          <MessageAttachment
            v-for="attachment in message.attachments"
            :key="attachment.id"
            :attachment="attachment"
          />
        </div>
      </div>

      <div class="message-footer">
        <div class="message-status">
          <Icon name="check" v-if="message.status === 'sent'" />
          <Icon name="check-double" v-if="message.status === 'delivered'" />
          <Icon name="check-double-fill" v-if="message.status === 'read'" />
        </div>

        <MessageActions
          :message="message"
          :is-own="isOwnMessage"
          @action="$emit('message-action', $event)"
        />
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import type { Message } from '@/types/chat'

interface Props {
  message: Message
  showAvatar?: boolean
  showHeader?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  showAvatar: true,
  showHeader: true
})

const emit = defineEmits<{
  messageAction: [action: MessageAction]
}>()

const messageClasses = computed(() => ({
  'message-own': isOwnMessage.value,
  'message-other': !isOwnMessage.value,
  'message-system': props.message.type === 'system',
  'message-typing': props.message.type === 'typing'
}))

const isOwnMessage = computed(() => props.message.isOwn)
const isOnline = computed(() => props.message.senderStatus === 'online')
</script>
```

#### MessageInput组件
```vue
<template>
  <div class="message-input-container">
    <div class="input-toolbar" v-if="showToolbar">
      <button class="toolbar-btn" @click="toggleEmoji">
        <Icon name="emoji" />
      </button>
      <button class="toolbar-btn" @click="selectFile">
        <Icon name="attachment" />
      </button>
      <button class="toolbar-btn" @click="toggleVoice">
        <Icon name="microphone" />
      </button>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <textarea
          ref="textareaRef"
          v-model="inputText"
          :placeholder="placeholder"
          :disabled="isSending"
          @keydown="handleKeydown"
          @input="handleInput"
          @paste="handlePaste"
          class="message-textarea"
        ></textarea>

        <div class="input-actions">
          <button
            class="send-btn"
            :disabled="!canSend"
            @click="handleSend"
          >
            <Icon name="send" v-if="!isSending" />
            <Icon name="loading" v-else class="spinning" />
          </button>
        </div>
      </div>

      <div class="typing-indicator" v-if="isTyping">
        <span>正在输入...</span>
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>

    <EmojiPicker
      v-if="showEmojiPicker"
      @select="insertEmoji"
      @close="showEmojiPicker = false"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed, nextTick } from 'vue'
import { useMessageInput } from '@/composables/useMessageInput'

interface Props {
  modelValue: string
  placeholder?: string
  isSending?: boolean
  showToolbar?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  placeholder: '输入消息...',
  isSending: false,
  showToolbar: true
})

const emit = defineEmits<{
  'update:modelValue': [value: string]
  send: [message: string]
  typing: [isTyping: boolean]
}>()

const {
  textareaRef,
  inputText,
  isTyping,
  autoResize,
  handleKeydown,
  handleInput,
  insertEmoji
} = useMessageInput()

const showEmojiPicker = ref(false)

const canSend = computed(() => {
  return inputText.value.trim().length > 0 && !props.isSending
})
</script>
```

### 样式系统

#### 消息气泡样式
```scss
// message.scss
.message-bubble {
  display: flex;
  margin-bottom: 1rem;
  animation: messageSlideIn 0.3s ease-out;

  &.message-own {
    flex-direction: row-reverse;

    .message-content {
      background: var(--color-primary);
      color: var(--color-primary-text);
      border-radius: 18px 18px 4px 18px;
    }
  }

  &.message-other {
    .message-content {
      background: var(--color-message-other);
      color: var(--color-text);
      border-radius: 18px 18px 18px 4px;
    }
  }
}

.message-avatar {
  position: relative;
  width: 40px;
  height: 40px;
  margin: 0 12px;
  flex-shrink: 0;

  img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .avatar-indicator {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid var(--color-background);
    background: var(--color-offline);

    &.online {
      background: var(--color-online);
    }
  }
}

.message-content {
  max-width: 70%;
  padding: 12px 16px;
  box-shadow: var(--shadow-message);
  position: relative;

  &::before {
    content: '';
    position: absolute;
    width: 0;
    height: 0;
    border-style: solid;
  }
}
```

#### 沉浸式模式样式
```scss
// chat.scss
.chat-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background: var(--color-chat-background);
  transition: all 0.3s ease;

  &.immersive-mode {
    .chat-header {
      transform: translateY(-100%);
      opacity: 0;
    }

    .chat-sidebar {
      transform: translateX(-100%);
      width: 0;
    }

    .message-list {
      padding: 2rem 1rem;
      background: var(--color-immersive-background);
    }
  }
}

.message-list {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  scroll-behavior: smooth;

  &::-webkit-scrollbar {
    width: 6px;
  }

  &::-webkit-scrollbar-track {
    background: transparent;
  }

  &::-webkit-scrollbar-thumb {
    background: var(--color-scrollbar);
    border-radius: 3px;
  }
}
```

#### 动画效果
```scss
// animations.scss
@keyframes messageSlideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes typingDots {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-10px);
  }
}

.typing-dots span {
  display: inline-block;
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--color-text-secondary);
  animation: typingDots 1.4s infinite;

  &:nth-child(2) {
    animation-delay: 0.2s;
  }

  &:nth-child(3) {
    animation-delay: 0.4s;
  }
}

.message-input-container {
  .message-textarea {
    resize: none;
    border: none;
    outline: none;
    background: transparent;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.5;
    min-height: 20px;
    max-height: 120px;
    transition: all 0.2s ease;

    &:focus {
      box-shadow: 0 0 0 2px var(--color-primary-alpha);
    }
  }
}
```

## Composable 逻辑实现

### useChat.ts
```typescript
import { ref, reactive } from 'vue'
import { useWebSocket } from '@/composables/useWebSocket'
import type { Message, ChatSession } from '@/types/chat'

export function useChat() {
  const messages = ref<Message[]>([])
  const currentSession = ref<ChatSession | null>(null)
  const isLoading = ref(false)
  const isSending = ref(false)

  const { socket, isConnected } = useWebSocket()

  const sendMessage = async (content: string) => {
    if (!content.trim() || isSending.value) return

    isSending.value = true

    try {
      const message: Message = {
        id: Date.now().toString(),
        content,
        timestamp: new Date(),
        isOwn: true,
        status: 'sending'
      }

      messages.value.push(message)

      // 通过WebSocket发送消息
      socket.emit('message', {
        sessionId: currentSession.value?.id,
        content
      })

      message.status = 'sent'
    } catch (error) {
      console.error('发送消息失败:', error)
    } finally {
      isSending.value = false
    }
  }

  return {
    messages,
    currentSession,
    isLoading,
    isSending,
    sendMessage
  }
}
```

## 验收标准

### 功能验收
- [ ] 消息气泡正确展示和排版
- [ ] 角色头像和信息正确显示
- [ ] 输入框功能完整且响应流畅
- [ ] 沉浸式模式正常工作

### 视觉验收
- [ ] 消息气泡设计美观且符合设计系统
- [ ] 深色主题完美适配
- [ ] 动画效果自然流畅
- [ ] 响应式布局在各设备上正常

### 交互验收
- [ ] 消息发送和接收实时性
- [ ] 输入框自适应高度调整
- [ ] 快捷键操作正常
- [ ] 消息操作功能完整

### 性能验收
- [ ] 大量消息加载性能良好
- [ ] 滚动流畅无卡顿
- [ ] 内存使用合理
- [ ] 实时通信延迟低

## 文件清单

### 新增文件
- `apps/web/src/views/chat/components/ChatContainer.vue`
- `apps/web/src/views/chat/components/MessageBubble.vue`
- `apps/web/src/views/chat/components/MessageInput.vue`
- `apps/web/src/views/chat/components/MessageActions.vue`
- `apps/web/src/views/chat/components/ChatHeader.vue`
- `apps/web/src/composables/useMessageInput.ts`
- `apps/web/src/composables/useChatUI.ts`
- `apps/web/src/views/chat/styles/message.scss`
- `apps/web/src/views/chat/styles/animations.scss`

### 修改文件
- `apps/web/src/views/chat/ChatSession.vue` - 重构主聊天页面
- `apps/web/src/views/chat/styles/chat.scss` - 更新聊天样式
- `apps/web/src/types/chat.ts` - 更新聊天类型定义

## 注意事项

1. **性能优化**：大量消息时使用虚拟滚动
2. **可访问性**：键盘导航和屏幕阅读器支持
3. **实时性**：确保WebSocket连接稳定
4. **响应式**：移动端触控体验优化
5. **主题一致性**：与整体设计系统保持一致
