# TavernAI Plus æ•°æ®åº“æ¶æ„æ‰©å±•æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### å½“å‰çŠ¶æ€åˆ†æ
- **æ•°æ®åº“**: SQLite + Prisma ORM
- **æ•°æ®è§„æ¨¡**: 50+ç”¨æˆ·ï¼Œ100+è§’è‰²ï¼Œ2000+å¯¹è¯æ¶ˆæ¯
- **æ¶æ„**: Monorepo (Turbo) + Vue 3 + Node.js + TypeScript
- **å·²æœ‰åŠŸèƒ½**: åŸºç¡€çš„AIè§’è‰²å¯¹è¯ã€ç”¨æˆ·ç®¡ç†ã€ç®€å•è¯„åˆ†ç³»ç»Ÿ

### æ‰©å±•ç›®æ ‡
è®¾è®¡æ”¯æŒé«˜çº§åŠŸèƒ½çš„æ•°æ®åº“æ¶æ„ï¼ŒåŒ…æ‹¬ï¼šè§’è‰²å¸‚åœºã€å¤šæ¨¡æ€AIã€ç¤¾åŒºåŠŸèƒ½ã€æ¨èç³»ç»Ÿã€å‘é‡æœç´¢ç­‰ã€‚

---

## ğŸ¯ ä¸€ã€æ•°æ®åº“è¿ç§»ç­–ç•¥

### 1.1 SQLite â†’ PostgreSQL è¿ç§»æ–¹æ¡ˆ

#### è¿ç§»æ—¶æœºé€‰æ‹©
```sql
-- å½“å‰æ•°æ®é‡è¯„ä¼°
SELECT 
    'users' as table_name, COUNT(*) as count FROM users
UNION ALL
SELECT 'characters', COUNT(*) FROM characters  
UNION ALL
SELECT 'messages', COUNT(*) FROM messages;
```

#### è¿ç§»æ­¥éª¤
1. **å‡†å¤‡é˜¶æ®µ** (0-1å¤©)
   - å®‰è£…PostgreSQL 15+
   - é…ç½®è¿æ¥æ± å’Œå¤åˆ¶
   - å‡†å¤‡è¿ç§»è„šæœ¬

2. **æ•°æ®è¿ç§»** (1-2å¤©)
   - å¯¼å‡ºSQLiteæ•°æ®
   - è½¬æ¢æ•°æ®æ ¼å¼
   - å¯¼å…¥PostgreSQL
   - éªŒè¯æ•°æ®å®Œæ•´æ€§

3. **åº”ç”¨åˆ‡æ¢** (0.5å¤©)
   - æ›´æ–°è¿æ¥å­—ç¬¦ä¸²
   - æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
   - å›æ»šæ–¹æ¡ˆå‡†å¤‡

#### è¿ç§»è„šæœ¬ç¤ºä¾‹
```typescript
// migration-scripts/sqlite-to-postgresql.ts
import { PrismaClient as SQLiteClient } from '@prisma/client-sqlite';
import { PrismaClient as PostgreSQLClient } from '@prisma/client';

export class DatabaseMigrator {
  private sqliteClient: SQLiteClient;
  private postgresClient: PostgreSQLClient;

  async migrate() {
    // 1. è¿ç§»ç”¨æˆ·æ•°æ®
    await this.migrateUsers();
    
    // 2. è¿ç§»è§’è‰²æ•°æ®
    await this.migrateCharacters();
    
    // 3. è¿ç§»ä¼šè¯å’Œæ¶ˆæ¯
    await this.migrateChatSessions();
    
    // 4. éªŒè¯æ•°æ®å®Œæ•´æ€§
    await this.validateMigration();
  }

  private async migrateUsers() {
    const users = await this.sqliteClient.user.findMany();
    
    for (const user of users) {
      await this.postgresClient.user.create({
        data: {
          ...user,
          metadata: typeof user.metadata === 'string' 
            ? JSON.parse(user.metadata || '{}') 
            : user.metadata
        }
      });
    }
  }

  private async validateMigration() {
    const sqliteCount = await this.sqliteClient.user.count();
    const postgresCount = await this.postgresClient.user.count();
    
    if (sqliteCount !== postgresCount) {
      throw new Error(`User count mismatch: SQLite=${sqliteCount}, PostgreSQL=${postgresCount}`);
    }
  }
}
```

### 1.2 æ•°æ®å®Œæ•´æ€§ä¿éšœ

#### è¿ç§»å‰æ£€æŸ¥
```sql
-- æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
SELECT 
    c.id,
    COUNT(DISTINCT cs.id) as session_count,
    COUNT(DISTINCT m.id) as message_count
FROM characters c
LEFT JOIN chat_sessions cs ON c.id = cs.character_id
LEFT JOIN messages m ON cs.id = m.session_id
GROUP BY c.id
HAVING session_count > 0 AND message_count = 0; -- å‘ç°ä¸ä¸€è‡´æ•°æ®
```

#### å›æ»šæœºåˆ¶
```typescript
// rollback-manager.ts
export class RollbackManager {
  async createBackup() {
    // SQLite å¤‡ä»½
    await this.backupSQLite();
    
    // PostgreSQL å¿«ç…§
    await this.createPostgreSQLSnapshot();
  }

  async rollback() {
    // æ¢å¤SQLiteæ•°æ®åº“
    await this.restoreSQLite();
    
    // æ›´æ–°åº”ç”¨é…ç½®
    await this.updateDatabaseConfig('sqlite');
  }
}
```

---

## ğŸ—ï¸ äºŒã€æ‰©å±•æ•°æ®åº“æ¶æ„è®¾è®¡

### 2.1 è§’è‰²å¸‚åœºå’Œåˆ†äº«åŠŸèƒ½

```sql
-- è§’è‰²ç‰ˆæœ¬ç®¡ç†
CREATE TABLE character_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    version_number INTEGER NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    changes JSONB, -- ç‰ˆæœ¬å˜æ›´è¯´æ˜
    published_by UUID REFERENCES users(id),
    is_published BOOLEAN DEFAULT false,
    download_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(character_id, version_number)
);

-- è§’è‰²å‘å¸ƒå’Œå®¡æ ¸
CREATE TABLE character_publications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    publisher_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    tags TEXT[], -- PostgreSQL æ•°ç»„ç±»å‹
    category_id UUID REFERENCES character_categories(id),
    price DECIMAL(10,2) DEFAULT 0.00, -- ä»˜è´¹è§’è‰²æ”¯æŒ
    license_type VARCHAR(50) DEFAULT 'free', -- free, premium, exclusive
    status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected, unlisted
    rejection_reason TEXT,
    featured_until TIMESTAMP,
    download_count INTEGER DEFAULT 0,
    revenue DECIMAL(10,2) DEFAULT 0.00,
    reviewed_by UUID REFERENCES users(id),
    reviewed_at TIMESTAMP,
    published_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è§’è‰²åˆ†ç±»ä½“ç³»
CREATE TABLE character_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    parent_id UUID REFERENCES character_categories(id),
    icon VARCHAR(255),
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- è§’è‰²ä¸‹è½½è®°å½•
CREATE TABLE character_downloads (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    version_number INTEGER NOT NULL,
    price_paid DECIMAL(10,2) DEFAULT 0.00,
    payment_id UUID REFERENCES transactions(id),
    download_url VARCHAR(500), -- ä¸´æ—¶ä¸‹è½½é“¾æ¥
    expires_at TIMESTAMP,
    downloaded_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(character_id, user_id, version_number)
);

-- åˆ›ä½œè€…æ”¶ç›Šåˆ†æˆ
CREATE TABLE creator_earnings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    creator_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    downloads INTEGER DEFAULT 0,
    gross_revenue DECIMAL(10,2) DEFAULT 0.00,
    platform_fee DECIMAL(10,2) DEFAULT 0.00,
    net_revenue DECIMAL(10,2) DEFAULT 0.00,
    payout_status VARCHAR(20) DEFAULT 'pending', -- pending, processing, paid
    payout_date DATE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 2.2 å¤šæ¨¡æ€AIæ”¯æŒ

```sql
-- åª’ä½“æ–‡ä»¶ç®¡ç†
CREATE TABLE media_files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    character_id UUID REFERENCES characters(id) ON DELETE CASCADE,
    filename VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    file_size BIGINT NOT NULL,
    storage_path VARCHAR(500) NOT NULL,
    storage_type VARCHAR(20) DEFAULT 'local', -- local, s3, oss
    width INTEGER, -- å›¾ç‰‡/è§†é¢‘å®½åº¦
    height INTEGER, -- å›¾ç‰‡/è§†é¢‘é«˜åº¦
    duration REAL, -- éŸ³é¢‘/è§†é¢‘æ—¶é•¿(ç§’)
    metadata JSONB DEFAULT '{}',
    processing_status VARCHAR(20) DEFAULT 'pending', -- pending, processing, completed, failed
    is_public BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è¯­éŸ³é…ç½®
CREATE TABLE voice_configurations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    voice_provider VARCHAR(50) NOT NULL, -- elevenlabs, azure, google
    voice_id VARCHAR(100) NOT NULL,
    voice_name VARCHAR(100),
    language VARCHAR(10) DEFAULT 'zh-CN',
    speed REAL DEFAULT 1.0,
    pitch REAL DEFAULT 1.0,
    stability REAL DEFAULT 0.5,
    similarity REAL DEFAULT 0.5,
    style_exaggeration REAL DEFAULT 0.0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- å¤šåª’ä½“æ¶ˆæ¯
CREATE TABLE multimedia_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id UUID NOT NULL REFERENCES messages(id) ON DELETE CASCADE,
    media_file_id UUID NOT NULL REFERENCES media_files(id) ON DELETE CASCADE,
    media_type VARCHAR(20) NOT NULL, -- image, audio, video, document
    generated_by VARCHAR(50), -- midjourney, dalle, elevenlabs, user_upload
    prompt_used TEXT, -- ç”Ÿæˆæ—¶ä½¿ç”¨çš„æç¤ºè¯
    generation_params JSONB, -- ç”Ÿæˆå‚æ•°
    processing_time INTEGER, -- å¤„ç†æ—¶é—´(æ¯«ç§’)
    created_at TIMESTAMP DEFAULT NOW()
);

-- å›¾åƒç”Ÿæˆå†å²
CREATE TABLE image_generations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    character_id UUID REFERENCES characters(id) ON DELETE SET NULL,
    prompt TEXT NOT NULL,
    negative_prompt TEXT,
    model VARCHAR(50) NOT NULL, -- dalle-3, midjourney, stable-diffusion
    width INTEGER DEFAULT 1024,
    height INTEGER DEFAULT 1024,
    steps INTEGER DEFAULT 20,
    guidance_scale REAL DEFAULT 7.5,
    seed BIGINT,
    generated_images JSONB, -- ç”Ÿæˆçš„å›¾ç‰‡URLæ•°ç»„
    status VARCHAR(20) DEFAULT 'pending', -- pending, generating, completed, failed
    error_message TEXT,
    generation_time INTEGER, -- ç”Ÿæˆæ—¶é—´(æ¯«ç§’)
    cost DECIMAL(8,4) DEFAULT 0.0000, -- ç”Ÿæˆæˆæœ¬
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);

-- è¯­éŸ³åˆæˆå†å²
CREATE TABLE speech_synthesis (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    character_id UUID REFERENCES characters(id) ON DELETE SET NULL,
    text TEXT NOT NULL,
    voice_config_id UUID REFERENCES voice_configurations(id),
    provider VARCHAR(50) NOT NULL,
    voice_id VARCHAR(100) NOT NULL,
    audio_file_id UUID REFERENCES media_files(id),
    status VARCHAR(20) DEFAULT 'pending',
    error_message TEXT,
    synthesis_time INTEGER,
    cost DECIMAL(8,4) DEFAULT 0.0000,
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);
```

### 2.3 ç¤¾åŒºåŠŸèƒ½å’Œç”¨æˆ·äº’åŠ¨

```sql
-- ç”¨æˆ·å…³ç³»(å…³æ³¨/ç²‰ä¸)
CREATE TABLE user_relationships (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    follower_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    following_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(20) DEFAULT 'active', -- active, blocked, muted
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(follower_id, following_id),
    CHECK(follower_id != following_id)
);

-- ç¤¾åŒºåŠ¨æ€
CREATE TABLE user_activities (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) NOT NULL, -- post, share_character, rate_character, achievement
    target_type VARCHAR(50), -- character, user, post
    target_id UUID, -- ç›®æ ‡å¯¹è±¡ID
    content TEXT,
    media_files UUID[], -- åª’ä½“æ–‡ä»¶IDæ•°ç»„
    metadata JSONB DEFAULT '{}',
    visibility VARCHAR(20) DEFAULT 'public', -- public, friends, private
    like_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    share_count INTEGER DEFAULT 0,
    is_pinned BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- åŠ¨æ€äº’åŠ¨(ç‚¹èµã€è¯„è®ºã€åˆ†äº«)
CREATE TABLE activity_interactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    activity_id UUID NOT NULL REFERENCES user_activities(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    interaction_type VARCHAR(20) NOT NULL, -- like, comment, share, report
    content TEXT, -- è¯„è®ºå†…å®¹
    parent_id UUID REFERENCES activity_interactions(id), -- å›å¤çš„è¯„è®ºID
    is_deleted BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(activity_id, user_id, interaction_type) -- æ¯ç§ç±»å‹åªèƒ½äº¤äº’ä¸€æ¬¡
);

-- ç¤¾åŒºè¯é¢˜å’Œè®¨è®ºç»„
CREATE TABLE community_topics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    creator_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(50) NOT NULL, -- general, character-creation, roleplay, technical
    tags TEXT[],
    rules JSONB, -- è¯é¢˜è§„åˆ™
    is_official BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    member_count INTEGER DEFAULT 0,
    post_count INTEGER DEFAULT 0,
    avatar VARCHAR(255),
    banner VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è¯é¢˜æˆå‘˜
CREATE TABLE topic_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    topic_id UUID NOT NULL REFERENCES community_topics(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(20) DEFAULT 'member', -- owner, moderator, member
    permissions JSONB DEFAULT '{}', -- æƒé™é…ç½®
    joined_at TIMESTAMP DEFAULT NOW(),
    last_active_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(topic_id, user_id)
);

-- é€šçŸ¥ç³»ç»Ÿ
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    sender_id UUID REFERENCES users(id) ON DELETE SET NULL,
    type VARCHAR(50) NOT NULL, -- follow, like, comment, share, system, achievement
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    action_url VARCHAR(500), -- ç‚¹å‡»é€šçŸ¥è·³è½¬çš„URL
    metadata JSONB DEFAULT '{}',
    is_read BOOLEAN DEFAULT false,
    is_deleted BOOLEAN DEFAULT false,
    priority VARCHAR(20) DEFAULT 'normal', -- low, normal, high, urgent
    expires_at TIMESTAMP, -- é€šçŸ¥è¿‡æœŸæ—¶é—´
    created_at TIMESTAMP DEFAULT NOW()
);

-- ç”¨æˆ·æ”¶è—å¤¹
CREATE TABLE user_collections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    is_public BOOLEAN DEFAULT false,
    item_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- æ”¶è—å¤¹é¡¹ç›®
CREATE TABLE collection_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    collection_id UUID NOT NULL REFERENCES user_collections(id) ON DELETE CASCADE,
    item_type VARCHAR(50) NOT NULL, -- character, activity, topic
    item_id UUID NOT NULL,
    notes TEXT, -- ç”¨æˆ·å¤‡æ³¨
    sort_order INTEGER DEFAULT 0,
    added_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(collection_id, item_type, item_id)
);
```

### 2.4 å‘é‡æ•°æ®åº“å’ŒAIåŠŸèƒ½

```sql
-- å‘é‡å­˜å‚¨æ‰©å±• (ä½¿ç”¨ pgvector)
CREATE EXTENSION IF NOT EXISTS vector;

-- è§’è‰²å‘é‡åŒ–è¡¨ç¤º
CREATE TABLE character_embeddings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    embedding_type VARCHAR(50) NOT NULL, -- description, personality, full_profile
    embedding vector(1536), -- OpenAI text-embedding-ada-002 ç»´åº¦
    model_name VARCHAR(100) NOT NULL, -- text-embedding-ada-002, text-embedding-3-large
    content_hash VARCHAR(64) NOT NULL, -- å†…å®¹å“ˆå¸Œï¼Œç”¨äºæ£€æµ‹æ˜¯å¦éœ€è¦é‡æ–°ç”Ÿæˆ
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(character_id, embedding_type, model_name)
);

-- ä¸ºå‘é‡æœç´¢åˆ›å»ºç´¢å¼•
CREATE INDEX idx_character_embeddings_vector ON character_embeddings 
USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

-- å¯¹è¯ä¸Šä¸‹æ–‡å‘é‡åŒ–
CREATE TABLE conversation_embeddings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES chat_sessions(id) ON DELETE CASCADE,
    message_window_start INTEGER NOT NULL, -- çª—å£å¼€å§‹æ¶ˆæ¯ä½ç½®
    message_window_end INTEGER NOT NULL, -- çª—å£ç»“æŸæ¶ˆæ¯ä½ç½®
    summary TEXT, -- å¯¹è¯æ‘˜è¦
    embedding vector(1536),
    model_name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(session_id, message_window_start, message_window_end)
);

-- é•¿æœŸè®°å¿†å­˜å‚¨
CREATE TABLE character_memories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    memory_type VARCHAR(50) NOT NULL, -- fact, preference, event, relationship
    content TEXT NOT NULL,
    importance_score REAL DEFAULT 0.5, -- 0-1 é‡è¦æ€§è¯„åˆ†
    confidence_score REAL DEFAULT 1.0, -- 0-1 ç½®ä¿¡åº¦
    embedding vector(1536),
    tags TEXT[],
    source_session_id UUID REFERENCES chat_sessions(id),
    source_message_id UUID REFERENCES messages(id),
    is_active BOOLEAN DEFAULT true,
    last_accessed_at TIMESTAMP,
    access_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- è§’è‰²æƒ…æ„ŸçŠ¶æ€å†å²
CREATE TABLE character_emotional_states (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    session_id UUID NOT NULL REFERENCES chat_sessions(id) ON DELETE CASCADE,
    emotional_state JSONB NOT NULL, -- {joy: 0.3, sadness: 0.1, anger: 0.05, ...}
    trigger_event TEXT, -- è§¦å‘æƒ…æ„Ÿå˜åŒ–çš„äº‹ä»¶
    context_summary TEXT,
    intensity REAL DEFAULT 0.5, -- æƒ…æ„Ÿå¼ºåº¦ 0-1
    duration_minutes INTEGER, -- æƒ…æ„ŸæŒç»­æ—¶é—´
    decay_rate REAL DEFAULT 0.1, -- æƒ…æ„Ÿè¡°å‡ç‡
    created_at TIMESTAMP DEFAULT NOW()
);

-- AI å­¦ä¹ è¿›åº¦å’ŒçŸ¥è¯†ç§¯ç´¯
CREATE TABLE character_learning_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    skill_type VARCHAR(100) NOT NULL, -- conversation, humor, empathy, domain_knowledge
    current_level REAL DEFAULT 0.0, -- å½“å‰æ°´å¹³ 0-100
    experience_points INTEGER DEFAULT 0,
    learning_data JSONB DEFAULT '{}', -- å­¦ä¹ ç›¸å…³æ•°æ®
    last_improvement_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(character_id, user_id, skill_type)
);

-- ä¸Šä¸‹æ–‡æ„ŸçŸ¥é…ç½®
CREATE TABLE context_awareness_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    config_name VARCHAR(100) NOT NULL,
    context_window_size INTEGER DEFAULT 4000, -- tokenæ•°é‡
    memory_retrieval_count INTEGER DEFAULT 5, -- æ£€ç´¢è®°å¿†æ•°é‡
    emotion_influence_weight REAL DEFAULT 0.3, -- æƒ…æ„Ÿå½±å“æƒé‡
    learning_adaptation_rate REAL DEFAULT 0.1, -- å­¦ä¹ é€‚åº”ç‡
    personality_consistency_weight REAL DEFAULT 0.8, -- äººæ ¼ä¸€è‡´æ€§æƒé‡
    context_filters JSONB DEFAULT '{}', -- ä¸Šä¸‹æ–‡è¿‡æ»¤å™¨
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(character_id, config_name)
);
```

### 2.5 ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿ

```sql
-- ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ª
CREATE TABLE user_behavior_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    action_type VARCHAR(50) NOT NULL, -- view, chat, rate, favorite, share, download
    target_type VARCHAR(50) NOT NULL, -- character, user, activity, topic
    target_id UUID NOT NULL,
    session_id VARCHAR(100), -- å‰ç«¯ä¼šè¯ID
    duration_seconds INTEGER, -- è¡Œä¸ºæŒç»­æ—¶é—´
    context JSONB DEFAULT '{}', -- è¡Œä¸ºä¸Šä¸‹æ–‡(é¡µé¢æ¥æºã€æœç´¢è¯ç­‰)
    device_info JSONB DEFAULT '{}', -- è®¾å¤‡ä¿¡æ¯
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ç‰©å“ç‰¹å¾çŸ©é˜µ
CREATE TABLE item_features (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    item_type VARCHAR(50) NOT NULL, -- character, topic, activity
    item_id UUID NOT NULL,
    feature_vector vector(512), -- ç‰¹å¾å‘é‡
    categorical_features JSONB DEFAULT '{}', -- åˆ†ç±»ç‰¹å¾
    numerical_features JSONB DEFAULT '{}', -- æ•°å€¼ç‰¹å¾
    popularity_score REAL DEFAULT 0.0,
    quality_score REAL DEFAULT 0.0,
    recency_score REAL DEFAULT 0.0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(item_type, item_id)
);

-- ç”¨æˆ·åå¥½å‘é‡
CREATE TABLE user_preference_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    profile_type VARCHAR(50) NOT NULL, -- character_preferences, topic_preferences
    preference_vector vector(512),
    explicit_preferences JSONB DEFAULT '{}', -- æ˜ç¡®åå¥½
    implicit_preferences JSONB DEFAULT '{}', -- éšå¼åå¥½
    confidence_score REAL DEFAULT 0.5,
    last_computed_at TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(user_id, profile_type)
);

-- æ¨èç»“æœç¼“å­˜
CREATE TABLE recommendation_cache (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    recommendation_type VARCHAR(50) NOT NULL, -- similar_characters, trending_topics, personalized_feed
    algorithm_version VARCHAR(20) NOT NULL,
    items JSONB NOT NULL, -- æ¨èé¡¹ç›®åˆ—è¡¨
    scores JSONB NOT NULL, -- å¯¹åº”çš„è¯„åˆ†
    explanation JSONB, -- æ¨èè§£é‡Š
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(user_id, recommendation_type, algorithm_version)
);

-- A/Bæµ‹è¯•é…ç½®
CREATE TABLE ab_test_experiments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL UNIQUE,
    description TEXT,
    status VARCHAR(20) DEFAULT 'draft', -- draft, running, completed, paused
    start_date DATE,
    end_date DATE,
    traffic_percentage REAL DEFAULT 100.0, -- å‚ä¸æµ‹è¯•çš„æµé‡ç™¾åˆ†æ¯”
    variants JSONB NOT NULL, -- å®éªŒå˜ä½“é…ç½®
    target_metrics TEXT[], -- ç›®æ ‡æŒ‡æ ‡
    success_criteria JSONB, -- æˆåŠŸæ ‡å‡†
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- A/Bæµ‹è¯•å‚ä¸è®°å½•
CREATE TABLE ab_test_participations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    experiment_id UUID NOT NULL REFERENCES ab_test_experiments(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    variant_name VARCHAR(100) NOT NULL,
    assigned_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(experiment_id, user_id)
);

-- A/Bæµ‹è¯•æŒ‡æ ‡æ”¶é›†
CREATE TABLE ab_test_metrics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    experiment_id UUID NOT NULL REFERENCES ab_test_experiments(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    variant_name VARCHAR(100) NOT NULL,
    metric_name VARCHAR(100) NOT NULL,
    metric_value REAL NOT NULL,
    metadata JSONB DEFAULT '{}',
    recorded_at TIMESTAMP DEFAULT NOW()
);
```

---

## ğŸš€ ä¸‰ã€æŠ€æœ¯æ¶æ„å®ç°

### 3.1 æ‰©å±•çš„Prisma Schema

```typescript
// prisma/schema-extended.prisma
generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
  previewFeatures = ["jsonProtocol", "postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

// æ‰©å±•ç°æœ‰æ¨¡å‹
model Character {
  // ... ç°æœ‰å­—æ®µ ...
  
  // æ–°å¢å­—æ®µ
  aiModel            String?               @default("gpt-3.5-turbo")
  voiceProvider      String?               @default("elevenlabs")
  emotionalRange     Float                 @default(1.0) // æƒ…æ„Ÿè¡¨è¾¾èŒƒå›´
  learningEnabled    Boolean               @default(true)
  memoryRetention    Int                   @default(100) // è®°å¿†ä¿ç•™æ•°é‡
  contextAwareness   Float                 @default(0.8) // ä¸Šä¸‹æ–‡æ„ŸçŸ¥åº¦
  
  // æ–°å…³ç³»
  versions           CharacterVersion[]
  publications       CharacterPublication[]
  downloads          CharacterDownload[]
  earnings           CreatorEarning[]
  embeddings         CharacterEmbedding[]
  memories           CharacterMemory[]
  emotionalStates    CharacterEmotionalState[]
  learningProgress   CharacterLearningProgress[]
  contextConfigs     ContextAwarenessConfig[]
  voiceConfigs       VoiceConfiguration[]
}

model User {
  // ... ç°æœ‰å­—æ®µ ...
  
  // æ–°å¢å­—æ®µ
  preferredLanguages String[]              @default(["zh-CN"])
  contentFilters     Json                  @default("{}")
  privacySettings    Json                  @default("{}")
  notificationPrefs  Json                  @default("{}")
  subscriptionFeatures Json               @default("{}")
  
  // æ–°å…³ç³»
  followers          UserRelationship[]    @relation("UserFollowers")
  following          UserRelationship[]    @relation("UserFollowing")
  activities         UserActivity[]
  interactions       ActivityInteraction[]
  collections        UserCollection[]
  behaviorLogs       UserBehaviorLog[]
  preferenceProfiles UserPreferenceProfile[]
  notifications      Notification[]
  topicMemberships   TopicMember[]
  mediaFiles         MediaFile[]
  imageGenerations   ImageGeneration[]
  speechSynthesis    SpeechSynthesis[]
  abTestParticipations ABTestParticipation[]
}

// æ–°æ¨¡å‹å®šä¹‰
model CharacterVersion {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  characterId     String    @db.Uuid
  versionNumber   Int
  name            String    @db.VarChar(255)
  description     String?   @db.Text
  changes         Json?
  publishedBy     String?   @db.Uuid
  isPublished     Boolean   @default(false)
  downloadCount   Int       @default(0)
  createdAt       DateTime  @default(now())
  
  character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  publisher       User?     @relation(fields: [publishedBy], references: [id])
  
  @@unique([characterId, versionNumber])
}

model UserRelationship {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  followerId   String   @db.Uuid
  followingId  String   @db.Uuid
  status       String   @default("active") @db.VarChar(20)
  createdAt    DateTime @default(now())
  
  follower     User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following    User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followingId])
}

// Unsupported ç±»å‹ - éœ€è¦åŸç”ŸSQLåˆ›å»º
// model CharacterEmbedding {
//   id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
//   characterId   String    @db.Uuid
//   embeddingType String    @db.VarChar(50)
//   embedding     Unsupported("vector(1536)")  // å‘é‡ç±»å‹
//   modelName     String    @db.VarChar(100)
//   contentHash   String    @db.VarChar(64)
//   metadata      Json      @default("{}")
//   createdAt     DateTime  @default(now())
//   updatedAt     DateTime  @updatedAt
//   
//   character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
//   
//   @@unique([characterId, embeddingType, modelName])
// }
```

### 3.2 å‘é‡æ•°æ®åº“é›†æˆ

```typescript
// services/vector-service.ts
import { Pool } from 'pg';

export class VectorService {
  private pool: Pool;

  constructor() {
    this.pool = new Pool({
      connectionString: process.env.DATABASE_URL
    });
  }

  async generateCharacterEmbedding(characterId: string): Promise<void> {
    const character = await prisma.character.findUnique({
      where: { id: characterId },
      include: { creator: true }
    });

    if (!character) throw new Error('Character not found');

    // ç”Ÿæˆembedding
    const embedding = await this.createEmbedding(
      `${character.name} ${character.description} ${character.personality}`
    );

    // å­˜å‚¨å‘é‡
    await this.pool.query(`
      INSERT INTO character_embeddings (character_id, embedding_type, embedding, model_name, content_hash)
      VALUES ($1, $2, $3, $4, $5)
      ON CONFLICT (character_id, embedding_type, model_name) 
      DO UPDATE SET 
        embedding = EXCLUDED.embedding,
        content_hash = EXCLUDED.content_hash,
        updated_at = NOW()
    `, [
      characterId,
      'full_profile',
      JSON.stringify(embedding),
      'text-embedding-ada-002',
      this.generateContentHash(character)
    ]);
  }

  async findSimilarCharacters(characterId: string, limit: number = 10): Promise<string[]> {
    const result = await this.pool.query(`
      SELECT 
        ce2.character_id,
        1 - (ce1.embedding <=> ce2.embedding) as similarity
      FROM character_embeddings ce1
      JOIN character_embeddings ce2 ON ce1.embedding_type = ce2.embedding_type
      WHERE ce1.character_id = $1 
        AND ce2.character_id != $1
        AND ce1.embedding_type = 'full_profile'
      ORDER BY ce1.embedding <=> ce2.embedding
      LIMIT $2
    `, [characterId, limit]);

    return result.rows.map(row => row.character_id);
  }

  async searchCharactersBySemantics(query: string, limit: number = 20): Promise<Array<{id: string, similarity: number}>> {
    const queryEmbedding = await this.createEmbedding(query);
    
    const result = await this.pool.query(`
      SELECT 
        character_id as id,
        1 - (embedding <=> $1) as similarity
      FROM character_embeddings
      WHERE embedding_type = 'full_profile'
      ORDER BY embedding <=> $1
      LIMIT $2
    `, [JSON.stringify(queryEmbedding), limit]);

    return result.rows;
  }

  private async createEmbedding(text: string): Promise<number[]> {
    // è°ƒç”¨ OpenAI Embedding API
    const response = await fetch('https://api.openai.com/v1/embeddings', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'text-embedding-ada-002',
        input: text
      })
    });

    const data = await response.json();
    return data.data[0].embedding;
  }

  private generateContentHash(character: any): string {
    const crypto = require('crypto');
    const content = `${character.name}${character.description}${character.personality}${character.updatedAt}`;
    return crypto.createHash('sha256').update(content).digest('hex');
  }
}
```

### 3.3 Redisç¼“å­˜ç­–ç•¥

```typescript
// services/cache-service.ts
import Redis from 'ioredis';

export class CacheService {
  private redis: Redis;

  constructor() {
    this.redis = new Redis(process.env.REDIS_URL);
  }

  // è§’è‰²ä¿¡æ¯ç¼“å­˜
  async cacheCharacter(characterId: string, character: any, ttl: number = 3600) {
    await this.redis.setex(
      `character:${characterId}`, 
      ttl, 
      JSON.stringify(character)
    );
  }

  async getCachedCharacter(characterId: string): Promise<any | null> {
    const cached = await this.redis.get(`character:${characterId}`);
    return cached ? JSON.parse(cached) : null;
  }

  // æ¨èç»“æœç¼“å­˜
  async cacheRecommendations(userId: string, type: string, recommendations: any[], ttl: number = 1800) {
    await this.redis.setex(
      `recommendations:${userId}:${type}`,
      ttl,
      JSON.stringify(recommendations)
    );
  }

  // çƒ­é—¨å†…å®¹ç¼“å­˜
  async cacheTrendingCharacters(characters: any[], ttl: number = 3600) {
    await this.redis.setex(
      'trending:characters',
      ttl,
      JSON.stringify(characters)
    );
  }

  // ç”¨æˆ·ä¼šè¯ç¼“å­˜
  async cacheUserSession(sessionId: string, sessionData: any, ttl: number = 7200) {
    await this.redis.setex(
      `session:${sessionId}`,
      ttl,
      JSON.stringify(sessionData)
    );
  }

  // åˆ†å¸ƒå¼é”
  async acquireLock(key: string, ttl: number = 30): Promise<boolean> {
    const result = await this.redis.set(
      `lock:${key}`,
      '1',
      'EX',
      ttl,
      'NX'
    );
    return result === 'OK';
  }

  async releaseLock(key: string): Promise<void> {
    await this.redis.del(`lock:${key}`);
  }

  // è®¡æ•°å™¨(ç‚¹èµã€ä¸‹è½½ç­‰)
  async incrementCounter(key: string, ttl?: number): Promise<number> {
    const multi = this.redis.multi();
    multi.incr(key);
    if (ttl) multi.expire(key, ttl);
    const results = await multi.exec();
    return results?.[0]?.[1] as number || 0;
  }

  // å®æ—¶ç»Ÿè®¡
  async addToSortedSet(key: string, score: number, member: string, ttl?: number): Promise<void> {
    const multi = this.redis.multi();
    multi.zadd(key, score, member);
    if (ttl) multi.expire(key, ttl);
    await multi.exec();
  }

  async getTopFromSortedSet(key: string, count: number = 10): Promise<Array<{member: string, score: number}>> {
    const results = await this.redis.zrevrange(key, 0, count - 1, 'WITHSCORES');
    const items = [];
    for (let i = 0; i < results.length; i += 2) {
      items.push({
        member: results[i],
        score: parseFloat(results[i + 1])
      });
    }
    return items;
  }
}
```

### 3.4 æ•°æ®åˆ†æå’ŒETLç®¡é“

```typescript
// services/analytics-service.ts
export class AnalyticsService {
  async collectUserBehavior(data: {
    userId: string;
    actionType: string;
    targetType: string;
    targetId: string;
    duration?: number;
    context?: any;
  }) {
    // å®æ—¶è®°å½•åˆ°æ•°æ®åº“
    await prisma.userBehaviorLog.create({
      data: {
        userId: data.userId,
        actionType: data.actionType,
        targetType: data.targetType,
        targetId: data.targetId,
        durationSeconds: data.duration,
        context: data.context || {},
        deviceInfo: await this.getDeviceInfo(),
        createdAt: new Date()
      }
    });

    // å¼‚æ­¥æ›´æ–°å®æ—¶ç»Ÿè®¡
    await this.updateRealTimeStats(data);
  }

  async generateDailyReport(date: Date) {
    const startOfDay = new Date(date);
    startOfDay.setHours(0, 0, 0, 0);
    
    const endOfDay = new Date(date);
    endOfDay.setHours(23, 59, 59, 999);

    // ç”¨æˆ·æ´»è·ƒåº¦ç»Ÿè®¡
    const userStats = await prisma.$queryRaw`
      SELECT 
        COUNT(DISTINCT user_id) as active_users,
        COUNT(*) as total_actions,
        AVG(duration_seconds) as avg_session_duration
      FROM user_behavior_logs 
      WHERE created_at BETWEEN ${startOfDay} AND ${endOfDay}
    `;

    // è§’è‰²ä½¿ç”¨ç»Ÿè®¡
    const characterStats = await prisma.$queryRaw`
      SELECT 
        target_id as character_id,
        COUNT(*) as interaction_count,
        COUNT(DISTINCT user_id) as unique_users
      FROM user_behavior_logs 
      WHERE target_type = 'character'
        AND action_type IN ('chat', 'view')
        AND created_at BETWEEN ${startOfDay} AND ${endOfDay}
      GROUP BY target_id
      ORDER BY interaction_count DESC
      LIMIT 50
    `;

    return {
      date: date.toISOString().split('T')[0],
      userStats: userStats[0],
      topCharacters: characterStats
    };
  }

  async updateUserPreferences(userId: string) {
    // åˆ†æç”¨æˆ·è¡Œä¸ºï¼Œæ›´æ–°åå¥½å‘é‡
    const recentBehaviors = await prisma.userBehaviorLog.findMany({
      where: {
        userId,
        createdAt: {
          gte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) // æœ€è¿‘30å¤©
        }
      },
      include: {
        // ç›¸å…³è”çš„ç›®æ ‡å¯¹è±¡ä¿¡æ¯
      }
    });

    // è®¡ç®—åå¥½å‘é‡
    const preferenceVector = await this.calculatePreferenceVector(recentBehaviors);
    
    // æ›´æ–°ç”¨æˆ·åå¥½æ¡£æ¡ˆ
    await prisma.userPreferenceProfile.upsert({
      where: {
        userId_profileType: {
          userId,
          profileType: 'character_preferences'
        }
      },
      update: {
        preferenceVector: JSON.stringify(preferenceVector),
        lastComputedAt: new Date()
      },
      create: {
        userId,
        profileType: 'character_preferences',
        preferenceVector: JSON.stringify(preferenceVector),
        lastComputedAt: new Date()
      }
    });
  }

  private async updateRealTimeStats(data: any) {
    const cache = new CacheService();
    
    // æ›´æ–°å®æ—¶è®¡æ•°å™¨
    await cache.incrementCounter(`stats:daily:${data.actionType}:${new Date().toISOString().split('T')[0]}`);
    
    // æ›´æ–°çƒ­é—¨æ’è¡Œæ¦œ
    if (data.targetType === 'character') {
      await cache.addToSortedSet(
        'trending:characters:hourly',
        Date.now(),
        data.targetId,
        3600 // 1å°æ—¶è¿‡æœŸ
      );
    }
  }

  private async calculatePreferenceVector(behaviors: any[]): Promise<number[]> {
    // åŸºäºç”¨æˆ·è¡Œä¸ºè®¡ç®—åå¥½å‘é‡çš„ç®—æ³•
    // è¿™é‡Œç®€åŒ–ä¸ºç¤ºä¾‹ï¼Œå®é™…å®ç°ä¼šæ›´å¤æ‚
    const vector = new Array(512).fill(0);
    
    for (const behavior of behaviors) {
      // æ ¹æ®è¡Œä¸ºç±»å‹å’Œç›®æ ‡ç‰¹å¾æ›´æ–°å‘é‡
      // å®é™…å®ç°éœ€è¦ç»“åˆæœºå™¨å­¦ä¹ ç®—æ³•
    }
    
    return vector;
  }

  private async getDeviceInfo(): Promise<any> {
    // ä»è¯·æ±‚å¤´è·å–è®¾å¤‡ä¿¡æ¯
    return {
      platform: 'web',
      version: '1.0.0'
    };
  }
}
```

---

## ğŸ”§ å››ã€è¿ç§»å®æ–½æ–¹æ¡ˆ

### 4.1 è¿ç§»æ—¶é—´è¡¨

```typescript
// migration/migration-plan.ts
export const MIGRATION_PHASES = {
  PHASE_1: {
    name: "æ•°æ®åº“è¿ç§»å‡†å¤‡",
    duration: "1-2å¤©",
    tasks: [
      "PostgreSQLç¯å¢ƒæ­å»º",
      "pgvectoræ‰©å±•å®‰è£…", 
      "Redisé›†ç¾¤é…ç½®",
      "æ•°æ®å¤‡ä»½è„šæœ¬å‡†å¤‡"
    ]
  },
  PHASE_2: {
    name: "æ ¸å¿ƒæ•°æ®è¿ç§»",
    duration: "1å¤©", 
    tasks: [
      "ç”¨æˆ·å’Œè§’è‰²æ•°æ®è¿ç§»",
      "èŠå¤©ä¼šè¯å’Œæ¶ˆæ¯è¿ç§»",
      "è¯„åˆ†å’Œæ”¶è—å…³ç³»è¿ç§»",
      "æ•°æ®å®Œæ•´æ€§éªŒè¯"
    ]
  },
  PHASE_3: {
    name: "æ‰©å±•åŠŸèƒ½å®ç°",
    duration: "3-5å¤©",
    tasks: [
      "å‘é‡åŒ–è¡¨ç»“æ„åˆ›å»º",
      "ç¤¾åŒºåŠŸèƒ½è¡¨åˆ›å»º", 
      "æ¨èç³»ç»Ÿè¡¨åˆ›å»º",
      "å¤šåª’ä½“æ”¯æŒè¡¨åˆ›å»º"
    ]
  },
  PHASE_4: {
    name: "æœåŠ¡å±‚é€‚é…",
    duration: "2-3å¤©",
    tasks: [
      "Prisma schemaæ›´æ–°",
      "APIæ¥å£é€‚é…",
      "ç¼“å­˜ç­–ç•¥å®æ–½",
      "æ€§èƒ½ä¼˜åŒ–è°ƒæ•´"
    ]
  },
  PHASE_5: {
    name: "æµ‹è¯•å’Œä¸Šçº¿",
    duration: "2å¤©",
    tasks: [
      "åŠŸèƒ½å›å½’æµ‹è¯•",
      "æ€§èƒ½å‹åŠ›æµ‹è¯•", 
      "æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥",
      "æ­£å¼ç¯å¢ƒåˆ‡æ¢"
    ]
  }
};
```

### 4.2 è¿ç§»è„šæœ¬

```typescript
// migration/migrate-to-postgresql.ts
import { PrismaClient as SQLiteClient } from '@prisma/client-sqlite';
import { PrismaClient as PostgreSQLClient } from '@prisma/client';

export class DatabaseMigrator {
  private sqliteClient: SQLiteClient;
  private postgresClient: PostgreSQLClient;
  private batchSize = 1000;

  constructor() {
    this.sqliteClient = new SQLiteClient({
      datasources: { db: { url: 'file:./dev.db' } }
    });
    this.postgresClient = new PostgreSQLClient();
  }

  async migrate() {
    console.log('ğŸš€ å¼€å§‹æ•°æ®åº“è¿ç§»...');
    
    try {
      // 1. åˆ›å»ºå¤‡ä»½
      await this.createBackup();
      
      // 2. è¿ç§»æ ¸å¿ƒæ•°æ®
      await this.migrateUsers();
      await this.migrateCharacters();
      await this.migrateChatSessions();
      await this.migrateMessages();
      await this.migrateRatingsAndFavorites();
      
      // 3. åˆ›å»ºæ‰©å±•è¡¨ç»“æ„
      await this.createExtendedTables();
      
      // 4. éªŒè¯æ•°æ®å®Œæ•´æ€§
      await this.validateMigration();
      
      console.log('âœ… æ•°æ®åº“è¿ç§»å®Œæˆ');
      
    } catch (error) {
      console.error('âŒ è¿ç§»å¤±è´¥:', error);
      await this.rollback();
      throw error;
    }
  }

  private async migrateUsers() {
    console.log('ğŸ“¤ è¿ç§»ç”¨æˆ·æ•°æ®...');
    
    const totalUsers = await this.sqliteClient.user.count();
    let migratedCount = 0;

    while (migratedCount < totalUsers) {
      const users = await this.sqliteClient.user.findMany({
        skip: migratedCount,
        take: this.batchSize,
        include: {
          oauthAccounts: true,
          refreshTokens: true
        }
      });

      for (const user of users) {
        await this.postgresClient.user.create({
          data: {
            ...user,
            // å¤„ç†JSONå­—æ®µ
            metadata: typeof user.metadata === 'string' 
              ? JSON.parse(user.metadata || '{}') 
              : user.metadata,
            // åˆ›å»ºå…³è”æ•°æ®
            oauthAccounts: {
              create: user.oauthAccounts.map(account => ({
                provider: account.provider,
                providerId: account.providerId,
                accessToken: account.accessToken,
                refreshToken: account.refreshToken,
                expiresAt: account.expiresAt,
                createdAt: account.createdAt,
                updatedAt: account.updatedAt
              }))
            },
            refreshTokens: {
              create: user.refreshTokens.map(token => ({
                token: token.token,
                expiresAt: token.expiresAt,
                createdAt: token.createdAt
              }))
            }
          }
        });
      }

      migratedCount += users.length;
      console.log(`ğŸ“Š å·²è¿ç§»ç”¨æˆ·: ${migratedCount}/${totalUsers}`);
    }
  }

  private async migrateCharacters() {
    console.log('ğŸ“¤ è¿ç§»è§’è‰²æ•°æ®...');
    
    const totalCharacters = await this.sqliteClient.character.count();
    let migratedCount = 0;

    while (migratedCount < totalCharacters) {
      const characters = await this.sqliteClient.character.findMany({
        skip: migratedCount,
        take: this.batchSize
      });

      for (const character of characters) {
        await this.postgresClient.character.create({
          data: {
            ...character,
            // å¤„ç†æ•°ç»„å­—æ®µ
            tags: typeof character.tags === 'string' 
              ? JSON.parse(character.tags || '[]') 
              : character.tags,
            // å¤„ç†JSONå­—æ®µ
            metadata: typeof character.metadata === 'string'
              ? JSON.parse(character.metadata || '{}')
              : character.metadata,
            // å¤„ç†å¯èƒ½çš„ç±»å‹è½¬æ¢
            temperature: character.temperature || 0.7,
            maxTokens: character.maxTokens || 1000
          }
        });
      }

      migratedCount += characters.length;
      console.log(`ğŸ“Š å·²è¿ç§»è§’è‰²: ${migratedCount}/${totalCharacters}`);
    }
  }

  private async createExtendedTables() {
    console.log('ğŸ—ï¸ åˆ›å»ºæ‰©å±•è¡¨ç»“æ„...');
    
    // æ‰§è¡Œæ‰©å±•è¡¨çš„SQLåˆ›å»ºè„šæœ¬
    const extendedSQL = await import('./extended-tables.sql');
    await this.postgresClient.$executeRawUnsafe(extendedSQL.default);
  }

  private async validateMigration() {
    console.log('ğŸ” éªŒè¯æ•°æ®å®Œæ•´æ€§...');
    
    const validations = [
      {
        name: 'ç”¨æˆ·æ•°é‡',
        sqlite: await this.sqliteClient.user.count(),
        postgres: await this.postgresClient.user.count()
      },
      {
        name: 'è§’è‰²æ•°é‡',
        sqlite: await this.sqliteClient.character.count(),
        postgres: await this.postgresClient.character.count()
      },
      {
        name: 'æ¶ˆæ¯æ•°é‡',
        sqlite: await this.sqliteClient.message.count(),
        postgres: await this.postgresClient.message.count()
      }
    ];

    for (const validation of validations) {
      if (validation.sqlite !== validation.postgres) {
        throw new Error(
          `${validation.name}ä¸åŒ¹é…: SQLite=${validation.sqlite}, PostgreSQL=${validation.postgres}`
        );
      }
      console.log(`âœ… ${validation.name}: ${validation.postgres}`);
    }
  }

  private async createBackup() {
    console.log('ğŸ’¾ åˆ›å»ºæ•°æ®å¤‡ä»½...');
    // å®ç°å¤‡ä»½é€»è¾‘
  }

  private async rollback() {
    console.log('ğŸ”„ æ‰§è¡Œå›æ»šæ“ä½œ...');
    // å®ç°å›æ»šé€»è¾‘
  }
}
```

### 4.3 æ€§èƒ½ä¼˜åŒ–é…ç½®

```sql
-- performance/postgresql-optimization.sql

-- æ•°æ®åº“é…ç½®ä¼˜åŒ–
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET work_mem = '4MB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET wal_buffers = '16MB';
ALTER SYSTEM SET default_statistics_target = 100;
SELECT pg_reload_conf();

-- åˆ›å»ºå¿…è¦çš„ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_user_behavior_logs_user_action 
ON user_behavior_logs(user_id, action_type, created_at DESC);

CREATE INDEX CONCURRENTLY idx_character_embeddings_similarity 
ON character_embeddings USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

CREATE INDEX CONCURRENTLY idx_characters_public_featured 
ON characters(is_public, is_featured, rating DESC) WHERE is_public = true;

CREATE INDEX CONCURRENTLY idx_messages_session_created 
ON messages(session_id, created_at DESC);

-- åˆ†åŒºè¡¨è®¾ç½®(é’ˆå¯¹å¤§è¡¨)
CREATE TABLE user_behavior_logs_partitioned (
    LIKE user_behavior_logs INCLUDING ALL
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE user_behavior_logs_y2024m01 PARTITION OF user_behavior_logs_partitioned
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- è‡ªåŠ¨åŒ–åˆ†åŒºç®¡ç†
CREATE OR REPLACE FUNCTION create_monthly_partition()
RETURNS void AS $$
DECLARE
    start_date date;
    end_date date;
    table_name text;
BEGIN
    start_date := date_trunc('month', CURRENT_DATE + interval '1 month');
    end_date := start_date + interval '1 month';
    table_name := 'user_behavior_logs_y' || extract(year from start_date) || 'm' || lpad(extract(month from start_date)::text, 2, '0');
    
    EXECUTE format('CREATE TABLE %I PARTITION OF user_behavior_logs_partitioned FOR VALUES FROM (%L) TO (%L)', 
                   table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;

-- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
CREATE OR REPLACE FUNCTION cleanup_old_behavior_logs()
RETURNS void AS $$
BEGIN
    DELETE FROM user_behavior_logs 
    WHERE created_at < CURRENT_DATE - interval '1 year';
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ“Š äº”ã€ç›‘æ§å’Œç»´æŠ¤

### 5.1 æ€§èƒ½ç›‘æ§

```typescript
// monitoring/performance-monitor.ts
export class PerformanceMonitor {
  async checkDatabaseHealth() {
    const results = await prisma.$queryRaw`
      SELECT 
        schemaname,
        tablename,
        attname,
        n_distinct,
        correlation
      FROM pg_stats 
      WHERE schemaname = 'public'
        AND n_distinct > 100
      ORDER BY n_distinct DESC
      LIMIT 20
    `;
    
    return results;
  }

  async getSlowQueries() {
    const results = await prisma.$queryRaw`
      SELECT 
        query,
        calls,
        total_time,
        mean_time,
        rows
      FROM pg_stat_statements 
      WHERE mean_time > 100  -- è¶…è¿‡100msçš„æŸ¥è¯¢
      ORDER BY mean_time DESC
      LIMIT 10
    `;
    
    return results;
  }

  async checkIndexUsage() {
    const results = await prisma.$queryRaw`
      SELECT 
        schemaname,
        tablename,
        indexname,
        idx_scan,
        idx_tup_read,
        idx_tup_fetch
      FROM pg_stat_user_indexes
      WHERE idx_scan = 0  -- æœªä½¿ç”¨çš„ç´¢å¼•
      ORDER BY tablename
    `;
    
    return results;
  }

  async monitorCacheHitRatio() {
    const results = await prisma.$queryRaw`
      SELECT 
        sum(heap_blks_read) as heap_read,
        sum(heap_blks_hit) as heap_hit,
        sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) as ratio
      FROM pg_statio_user_tables
    `;
    
    return results[0];
  }
}
```

### 5.2 è‡ªåŠ¨åŒ–ç»´æŠ¤

```typescript
// maintenance/database-maintenance.ts
export class DatabaseMaintenance {
  async vacuumAnalyze() {
    await prisma.$executeRaw`VACUUM ANALYZE`;
  }

  async reindexTables() {
    const tables = ['characters', 'messages', 'user_behavior_logs'];
    
    for (const table of tables) {
      await prisma.$executeRawUnsafe(`REINDEX TABLE ${table}`);
    }
  }

  async updateStatistics() {
    await prisma.$executeRaw`ANALYZE`;
  }

  async cleanupExpiredData() {
    // æ¸…ç†è¿‡æœŸçš„æ¨èç¼“å­˜
    await prisma.recommendationCache.deleteMany({
      where: {
        expiresAt: {
          lt: new Date()
        }
      }
    });

    // æ¸…ç†æ—§çš„è¡Œä¸ºæ—¥å¿—
    await prisma.userBehaviorLog.deleteMany({
      where: {
        createdAt: {
          lt: new Date(Date.now() - 365 * 24 * 60 * 60 * 1000) // 1å¹´å‰
        }
      }
    });
  }
}
```

---

## ğŸ¯ å…­ã€å®æ–½å»ºè®®

### 6.1 ä¼˜å…ˆçº§æ’åº

1. **é«˜ä¼˜å…ˆçº§** (ç«‹å³å®æ–½)
   - SQLite â†’ PostgreSQL è¿ç§»
   - åŸºç¡€å‘é‡æœç´¢åŠŸèƒ½
   - Redisç¼“å­˜å®ç°
   - æ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–

2. **ä¸­ä¼˜å…ˆçº§** (1-2å‘¨å†…)
   - è§’è‰²å¸‚åœºåŠŸèƒ½
   - åŸºç¡€ç¤¾åŒºåŠŸèƒ½
   - ç”¨æˆ·è¡Œä¸ºåˆ†æ
   - æ¨èç³»ç»ŸV1

3. **ä½ä¼˜å…ˆçº§** (1-2æœˆå†…)
   - å¤šæ¨¡æ€AIåŠŸèƒ½
   - é«˜çº§åˆ†æåŠŸèƒ½
   - A/Bæµ‹è¯•ç³»ç»Ÿ
   - å®Œæ•´çš„æ•°æ®ä»“åº“

### 6.2 é£é™©æ§åˆ¶

```typescript
// risk-management/migration-safety.ts
export class MigrationSafety {
  async createCheckpoint(name: string) {
    // åˆ›å»ºæ•°æ®åº“æ£€æŸ¥ç‚¹
    await prisma.$executeRaw`CHECKPOINT ${name}`;
  }

  async validateDataConsistency() {
    // æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
    const inconsistencies = [];
    
    // æ£€æŸ¥å¤–é”®çº¦æŸ
    const orphanedRecords = await prisma.$queryRaw`
      SELECT 'characters' as table_name, COUNT(*) as count
      FROM characters c
      LEFT JOIN users u ON c.creator_id = u.id
      WHERE u.id IS NULL
      
      UNION ALL
      
      SELECT 'messages', COUNT(*)
      FROM messages m
      LEFT JOIN chat_sessions cs ON m.session_id = cs.id
      WHERE cs.id IS NULL
    `;
    
    return orphanedRecords;
  }

  async setupMonitoring() {
    // è®¾ç½®ç›‘æ§å‘Šè­¦
    // é›†æˆåˆ°ç°æœ‰çš„ç›‘æ§ç³»ç»Ÿ
  }
}
```

### 6.3 æˆæœ¬ä¼°ç®—

```typescript
// cost-analysis/infrastructure-cost.ts
export const INFRASTRUCTURE_COSTS = {
  postgresql: {
    development: "$50/æœˆ",  // å°å‹å®ä¾‹
    production: "$200/æœˆ"   // é«˜å¯ç”¨é›†ç¾¤
  },
  redis: {
    development: "$30/æœˆ",  // å•å®ä¾‹
    production: "$150/æœˆ"   // é›†ç¾¤æ¨¡å¼
  },
  vectorDatabase: {
    development: "$100/æœˆ", // Pinecone/Weaviate
    production: "$500/æœˆ"   // ä¼ä¸šçº§
  },
  storage: {
    development: "$20/æœˆ",  // åŸºç¡€å­˜å‚¨
    production: "$100/æœˆ"   // é«˜æ€§èƒ½å­˜å‚¨
  },
  monitoring: {
    development: "$0",      // å¼€æºæ–¹æ¡ˆ
    production: "$50/æœˆ"    // ä¸“ä¸šç›‘æ§
  },
  total: {
    development: "$200/æœˆ",
    production: "$1000/æœˆ"
  }
};
```

---

## ğŸ“‹ ä¸ƒã€æ€»ç»“

è¿™ä¸ªæ•°æ®åº“æ¶æ„æ‰©å±•æ–¹æ¡ˆä¸ºTavernAI Plusæä¾›äº†æ”¯æŒæ‰€æœ‰é«˜çº§åŠŸèƒ½çš„å®Œæ•´åŸºç¡€è®¾æ–½ã€‚ä¸»è¦ç‰¹ç‚¹ï¼š

### âœ… æ ¸å¿ƒä¼˜åŠ¿
1. **å¯æ‰©å±•æ€§**: æ”¯æŒä»å½“å‰50ç”¨æˆ·æ‰©å±•åˆ°50ä¸‡ç”¨æˆ·
2. **é«˜æ€§èƒ½**: å‘é‡æœç´¢ã€Redisç¼“å­˜ã€åˆ†åŒºè¡¨ä¼˜åŒ–
3. **åŠŸèƒ½å®Œæ•´**: æ¶µç›–è§’è‰²å¸‚åœºã€ç¤¾åŒºã€æ¨èã€å¤šæ¨¡æ€AIç­‰
4. **ç”Ÿäº§å°±ç»ª**: å®Œæ•´çš„ç›‘æ§ã€å¤‡ä»½ã€å›æ»šæœºåˆ¶

### ğŸ¯ å®æ–½è·¯å¾„
1. **ç¬¬ä¸€é˜¶æ®µ**: PostgreSQLè¿ç§» + åŸºç¡€ä¼˜åŒ–
2. **ç¬¬äºŒé˜¶æ®µ**: å‘é‡æœç´¢ + æ¨èç³»ç»Ÿ
3. **ç¬¬ä¸‰é˜¶æ®µ**: ç¤¾åŒºåŠŸèƒ½ + è§’è‰²å¸‚åœº  
4. **ç¬¬å››é˜¶æ®µ**: å¤šæ¨¡æ€AI + é«˜çº§åˆ†æ

### ğŸ“ˆ é¢„æœŸæ•ˆæœ
- **æŸ¥è¯¢æ€§èƒ½**: æå‡10-50å€
- **åŠŸèƒ½ä¸°å¯Œåº¦**: å¢åŠ 300%+æ ¸å¿ƒåŠŸèƒ½
- **ç”¨æˆ·ä½“éªŒ**: ä¸ªæ€§åŒ–æ¨èå‡†ç¡®ç‡>85%
- **ç³»ç»Ÿç¨³å®šæ€§**: 99.9%å¯ç”¨æ€§ä¿éšœ

è¿™ä¸ªæ–¹æ¡ˆéµå¾ªäº†é¡¹ç›®çš„æ ¸å¿ƒåŸåˆ™ï¼Œä½¿ç”¨çœŸå®æ•°æ®ï¼Œæä¾›ç”Ÿäº§çº§è´¨é‡ï¼Œä¸ºTavernAI Plusçš„é•¿æœŸå‘å±•å¥ å®šåšå®åŸºç¡€ã€‚